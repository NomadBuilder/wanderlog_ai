<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WanderLog AI ‚Äî Your Living Travel Memoir</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .tagline {
      font-size: 1.2rem;
      font-weight: 300;
      opacity: 0.9;
    }

    .main-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
      gap: 20px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .step.active {
      background: #667eea;
      color: white;
    }

    .step.completed {
      background: #10b981;
      color: white;
    }

    .step.pending {
      background: #f3f4f6;
      color: #6b7280;
    }

    .step:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .step.completed:hover {
      background: #059669;
    }

    .step.pending:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .step.active .step-number {
      background: rgba(255,255,255,0.2);
    }

    .step.completed .step-number {
      background: rgba(255,255,255,0.2);
    }

    .step.pending .step-number {
      background: #d1d5db;
    }

    .step.loading .step-number {
      background: #fbbf24;
      color: white;
    }

    .step.error .step-number {
      background: #ef4444;
      color: white;
    }

    .step-content {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .step-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }

    .form-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .cities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .city-card {
      border: 2px solid #e5e7eb;
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .city-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .city-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .city-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .city-activities {
      list-style: none;
      margin-top: 10px;
    }

    .city-activities li {
      padding: 5px 0;
      color: #6b7280;
      font-size: 14px;
    }

    .city-activities li:before {
      content: "üìç ";
      color: #667eea;
    }

    .memory-prompts {
      background: #f9fafb;
      border-radius: 15px;
      padding: 30px;
      margin-top: 20px;
    }

    .prompt-item {
      margin-bottom: 25px;
    }

    .prompt-question {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .prompt-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }

    .prompt-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .city-section {
      background: #f8fafc;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border-left: 4px solid #667eea;
    }

    .city-section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .city-section-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1f2937;
    }

    .city-section-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .refresh-btn {
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      color: #6b7280;
    }

    .refresh-btn:hover {
      border-color: #667eea;
      color: #667eea;
      background: #f0f4ff;
    }

    .prompt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .narrative-preview {
      background: #f0f4ff;
      border-radius: 15px;
      padding: 30px;
      margin-top: 20px;
      border-left: 5px solid #667eea;
    }

    .narrative-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .narrative-header h3 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1f2937;
    }

    .narrative-text {
      line-height: 1.8;
      color: #1f2937;
      font-size: 16px;
    }

    .narrative-textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
    }

    .style-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-style {
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-style:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .btn-style.active {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }

    .hidden {
      display: none;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      gap: 10px;
    }

    .nav-tab {
      padding: 15px 30px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-tab:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .nav-tab.active {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    /* Page Content */
    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
    }

    /* My Stories Page */
    .stories-header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .stories-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stories-header p {
      color: #fff;
      font-size: 1.18rem;
      font-weight: 500;
      margin-bottom: 30px;
      letter-spacing: 0.01em;
      text-shadow: 0 2px 8px rgba(60,60,100,0.10);
    }

    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .country-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
      min-width: 320px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .country-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      border-color: #667eea;
    }

    .country-card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .country-flag {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .country-info h3 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .country-info p {
      color: #6b7280;
      font-size: 14px;
    }

    .country-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .country-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      width: 100%;
      box-sizing: border-box;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
    }

    .btn-share {
      background: #8b5cf6;
      color: white;
    }

    .btn-share:hover {
      background: #7c3aed;
    }

    .share-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .share-modal.show {
      display: flex;
    }

    .share-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .share-modal-header h3 {
      margin: 0;
      color: #1f2937;
    }

    .share-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 5px;
    }

    .share-modal-close:hover {
      color: #374151;
    }

    .share-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .share-option {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .share-option:hover {
      border-color: #667eea;
      background: #f8fafc;
    }

    .share-option-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .share-option-text {
      flex: 1;
    }

    .share-option-text h4 {
      margin: 0 0 5px 0;
      color: #1f2937;
    }

    .share-option-text p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }

    .share-link {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .share-link input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .share-link input:focus {
      outline: none;
      border-color: #667eea;
    }

    .copy-btn {
      padding: 12px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    .copy-btn:hover {
      background: #5a67d8;
    }

    .copy-btn.copied {
      background: #10b981;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: white;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.7;
    }

    .empty-state h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 30px;
    }

    /* Photo Upload Styles */
    .photo-upload-section {
      margin-top: 15px;
      padding: 15px;
      border: 2px dashed #e5e7eb;
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s ease;
      max-width: 400px;
    }

    .photo-upload-section:hover {
      border-color: #667eea;
      background: #f8fafc;
    }

    .photo-upload-section.dragover {
      border-color: #667eea;
      background: #eff6ff;
    }

    .photo-upload-icon {
      font-size: 1.5rem;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .photo-upload-text {
      color: #6b7280;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .photo-upload-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .photo-upload-btn:hover {
      background: #5a67d8;
    }

    .photo-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .photo-item {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .photo-item img {
      width: 100%;
      height: 80px;
      object-fit: cover;
    }

    .photo-remove {
      position: absolute;
      top: 3px;
      right: 3px;
      background: rgba(220, 38, 38, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .photo-remove:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
    }

    /* Layout Options Styles */
    .layout-options {
      margin: 20px 0;
      padding: 20px;
      display: flex;
      gap: 15px;
    }

    .layout-option {
      cursor: pointer;
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .layout-option:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .layout-option.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    .layout-preview {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .preview-line {
      height: 20px;
      background: #e5e7eb;
      margin-bottom: 5px;
    }

    .preview-line.short {
      width: 50px;
    }

    .preview-line.long {
      width: 100px;
    }

    .preview-line.classic-preview {
      background: #667eea;
    }

    .preview-line.journal-preview {
      background: #764ba2;
    }

    .preview-line.poetic-preview {
      background: #8b5cf6;
    }

    .preview-line.adventure-preview {
      background: #10b981;
    }

    .preview-line.elegant-preview {
      background: #f3f4f6;
    }

    /* Generate Story Section Styles */
    .generate-story-section {
      text-align: center;
      margin: 30px 0;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      color: white;
    }

    .generate-story-section .btn-large {
      padding: 16px 32px;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .generate-story-section .btn-large:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .generate-note {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }

    /* Profile Styles */
    .profile-header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .profile-settings {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .profile-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      flex: 1;
    }

    .profile-avatar {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .avatar-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #6b7280;
    }

    .avatar-upload-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .avatar-upload-btn:hover {
      background: #5a67d8;
    }

    .profile-info {
      text-align: center;
    }

    .profile-name-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .profile-name-input {
      width: 200px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }

    .profile-status {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(26px);
      -ms-transform: translateX(26px);
      transform: translateX(26px);
    }

    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    .status-text {
      font-size: 14px;
      color: #6b7280;
    }

    .profile-bio {
      margin-bottom: 20px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      text-align: left;
    }

    .profile-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .public-stories-section {
      margin-top: 40px;
    }

    .section-header {
      text-align: center;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .public-stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .public-story-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .public-story-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }

    .public-story-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .public-story-flag {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .public-story-info {
      flex: 1;
    }

    .public-story-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .public-story-summary {
      font-size: 14px;
      color: #6b7280;
    }

    .profile-link-section {
      text-align: center;
      margin-top: 40px;
    }

    .profile-link-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .profile-link-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .profile-link-input {
      width: 200px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }

    .copy-profile-link-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .copy-profile-link-btn:hover {
      background: #5a67d8;
    }

    .profile-link-note {
      font-size: 14px;
      color: #6b7280;
      margin-top: 10px;
    }

    /* Public Button Styles */
    .btn-public {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-public:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .btn-public.private {
      background: #6b7280;
    }

    .btn-public.private:hover {
      background: #4b5563;
    }

    /* No Public Stories State */
    .no-public-stories {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
      grid-column: 1 / -1;
    }

    .no-public-stories i {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .no-public-stories h3 {
      margin-bottom: 10px;
      color: #374151;
    }

    /* Public Story Card Styles */
    .public-story-excerpt {
      margin: 15px 0;
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }

    .public-story-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .world-map svg {
      width: 100%;
      height: 400px;
      display: block;
    }
    .country-shape {
      fill: #e5e7eb;
      stroke: #cbd5e1;
      stroke-width: 2;
      cursor: pointer;
      transition: fill 0.2s, stroke 0.2s;
    }
    .country-shape.visited {
      fill: #667eea;
      stroke: #4338ca;
    }
    .country-shape:hover {
      fill: #a5b4fc;
      stroke: #6366f1;
    }

    /* Date Input Styles */
    .date-input-container {
      position: relative;
    }

    .date-input-row {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }

    .date-input-group {
      flex: 1;
    }

    .date-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 5px;
    }

    .date-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      background: white;
      transition: all 0.3s ease;
    }

    .date-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .date-input-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .date-input-row {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Export Button Styles */
    .btn-export {
      background: #059669;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-export:hover {
      background: #047857;
      transform: translateY(-2px);
    }

    /* Export Modal Styles */
    .export-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .export-modal.show {
      display: flex;
    }

    .export-modal-content {
      background: white;
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .export-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px 30px;
      border-bottom: 1px solid #e5e7eb;
    }

    .export-modal-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }

    .export-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .export-modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .export-options {
      padding: 30px;
    }

    .export-option {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .export-option:hover {
      border-color: #667eea;
      background: #f8fafc;
      transform: translateY(-2px);
    }

    .export-icon {
      font-size: 2rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      border-radius: 12px;
      flex-shrink: 0;
    }

    .export-info h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 5px 0;
    }

    .export-info p {
      color: #6b7280;
      margin: 0;
      font-size: 14px;
      line-height: 1.4;
    }

    .export-footer {
      padding: 20px 30px;
      border-top: 1px solid #e5e7eb;
      text-align: right;
    }

    @media (max-width: 768px) {
      .export-option {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .export-icon {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .step.loading {
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }
    
    .step.completed {
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
    
    .step.error {
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }

    .length-option {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .length-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .length-option.active {
      border-color: #667eea;
      background: #f0f4ff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .layout-option {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: flex-start;
      gap: 15px;
      min-width: 200px;
      flex: 1;
    }

    .layout-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .layout-option.active {
      border-color: #667eea;
      background: #f0f4ff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .layout-icon {
      font-size: 24px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .layout-content {
      flex: 1;
    }

    .layout-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .layout-description {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.4;
    }

    .layout-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    /* --- Modern Search Bar & Filter for My Stories --- */
    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }
    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-input-wrapper input[type="text"] {
      padding: 10px 14px 10px 38px;
      border-radius: 24px;
      border: none;
      background: #f4f6fa;
      font-size: 1.08rem;
      box-shadow: 0 2px 8px 0 rgba(60,60,100,0.07);
      outline: none;
      transition: box-shadow 0.2s;
      min-width: 260px;
      color: #3b3663;
    }
    .search-input-wrapper input[type="text"]:focus {
      box-shadow: 0 4px 16px 0 rgba(60,60,100,0.13);
      background: #fff;
    }
    .search-input-wrapper .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #667eea;
      font-size: 1.3em;
      pointer-events: none;
    }
    .stories-filter {
      border-radius: 24px;
      border: none;
      background: #f4f6fa;
      font-size: 1.08rem;
      padding: 10px 36px 10px 16px;
      color: #3b3663;
      box-shadow: 0 2px 8px 0 rgba(60,60,100,0.07);
      outline: none;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23667eea" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px 20px;
      min-width: 100px;
      margin-left: 0;
    }
    .stories-filter:focus {
      box-shadow: 0 4px 16px 0 rgba(60,60,100,0.13);
      background: #fff;
    }
    @media (max-width: 600px) {
      .search-container {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      .search-input-wrapper input[type="text"], .stories-filter {
        min-width: 0;
        width: 100%;
      }
    }

    /* --- Modal Fixes for Story Detail Modal --- */
    .story-detail-modal {
      display: flex !important;
      opacity: 1 !important;
      z-index: 99999 !important;
      background: rgba(0,0,0,0.7) !important;
      border: 5px solid red !important;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
      opacity: 0;
    }
    .story-detail-modal.show {
      display: flex !important;
      opacity: 1;
      z-index: 99999;
    }
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .story-detail-modal-content {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 40px rgba(60,60,100,0.18);
      max-width: 600px;
      width: 95vw;
      padding: 32px 28px 24px 28px;
      position: relative;
      animation: modalPopIn 0.25s;
    }
    @keyframes modalPopIn {
      from { transform: scale(0.97) translateY(30px); }
      to { transform: scale(1) translateY(0); }
    }

    /* --- Guaranteed Modal Visibility --- */
    .story-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 999999;
      background: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .story-detail-modal.show {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
      background: rgba(0,0,0,0.95) !important;
      z-index: 9999999 !important;
    }

    .story-detail-modal-content {
      background: #fff !important;
      border: 6px solid #ff00cc !important;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
      position: relative;
    }

    .story-detail-modal-content::before {
      content: 'MODAL IS VISIBLE';
      display: block;
      background: #fff0f3;
      color: #ff0033;
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      padding: 24px 0 10px 0;
      border-bottom: 2px solid #ff00cc;
      margin-bottom: 18px;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .story-detail-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 25px 30px 20px;
      border-bottom: 1px solid #e8e8e8;
    }

    .story-detail-header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .story-country-flag {
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .story-detail-header-info h3 {
      margin: 0 0 5px 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #3b3663;
    }

    .story-detail-header-info p {
      margin: 0;
      color: #7b7b93;
      font-size: 1rem;
    }

    .story-detail-modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: #7b7b93;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .story-detail-modal-close:hover {
      background: #f8f9fa;
      color: #3b3663;
    }

    .story-detail-content {
      padding: 25px 30px;
    }

    .story-detail-photos {
      margin-bottom: 25px;
    }

    .story-detail-narrative {
      margin-bottom: 25px;
    }

    .story-detail-narrative h4 {
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #3b3663;
    }

    .story-narrative-text {
      line-height: 1.6;
      color: #4a4a4a;
      font-size: 1rem;
    }

    .story-detail-cities h4 {
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #3b3663;
    }

    .story-cities-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .story-cities-list span {
      background: #f0f2f5;
      color: #3b3663;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .story-detail-actions {
      display: flex;
      gap: 12px;
      padding: 20px 30px 25px;
      border-top: 1px solid #e8e8e8;
      flex-wrap: wrap;
    }

    .story-detail-actions .btn {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .story-detail-actions .btn-primary {
      background: #6366f1;
      color: white;
    }

    .story-detail-actions .btn-primary:hover {
      background: #5855eb;
    }

    .story-detail-actions .btn-secondary {
      background: #f8f9fa;
      color: #3b3663;
      border: 1px solid #e8e8e8;
    }

    .story-detail-actions .btn-secondary:hover {
      background: #e9ecef;
    }

    .story-detail-actions .btn-export {
      background: #10b981;
      color: white;
    }

    .story-detail-actions .btn-export:hover {
      background: #059669;
    }

    .story-detail-actions .btn-danger {
      background: #ef4444;
      color: white;
    }

    .story-detail-actions .btn-danger:hover {
      background: #dc2626;
    }

    @media (max-width: 768px) {
      .story-detail-modal {
        padding: 10px;
      }
      
      .story-detail-modal-content {
        max-height: 95vh;
      }
      
      .story-detail-modal-header {
        padding: 20px 20px 15px;
      }
      
      .story-detail-content {
        padding: 20px;
      }
      
      .story-detail-actions {
        padding: 15px 20px 20px;
        flex-direction: column;
      }
      
      .story-detail-actions .btn {
        width: 100%;
      }
    }

    /* Story Detail Page Styles */
    .story-detail-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .story-detail-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .back-button {
      background: #f3f4f6;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-button:hover {
      background: #e5e7eb;
      transform: translateX(-2px);
    }

    .story-title h1 {
      margin: 0;
      font-size: 2.5rem;
      color: #1f2937;
    }

    .story-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 8px;
    }

    .story-meta .flag {
      font-size: 2rem;
    }

    .story-meta .date {
      color: #6b7280;
      font-size: 1.1rem;
    }

    .story-detail-body {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .story-narrative h2,
    .story-cities h3,
    .story-photos h3 {
      color: #1f2937;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .story-narrative p {
      line-height: 1.8;
      color: #374151;
      font-size: 1.1rem;
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .cities-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .cities-list .city-tag {
      background: #667eea;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .photo-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .photo-item img:hover {
      transform: scale(1.05);
    }

    .story-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
    }

    .story-actions .btn {
      padding: 12px 24px;
      font-size: 14px;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-globe-americas"></i>
        WanderLog AI
      </div>
      <div class="tagline">
        Remember everywhere you've been. Write the story you never had time to record.
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('create', event)">
        <i class="fas fa-plus"></i>
        Create Story
      </button>
      <button class="nav-tab" onclick="showPage('stories', event)">
        <i class="fas fa-book-open"></i>
        My Stories
      </button>
      <button class="nav-tab" onclick="showPage('map', event)">
        <i class="fas fa-map-marked-alt"></i>
        Map View
      </button>
      <button class="nav-tab" onclick="showPage('profile', event)">
        <i class="fas fa-user-circle"></i>
        Public Profile
      </button>
      <button class="nav-tab" onclick="clearStoryData()" style="background: #ef4444; color: white;">
        <i class="fas fa-trash"></i>
        Clear Data
      </button>
    </div>

    <!-- Create Story Page -->
    <div class="page-content active" id="create-page">
      <div class="main-content">
        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step active" id="step1" data-step="1" onclick="goToStep(1)">
            <div class="step-number">1</div>
            <span>Choose Country</span>
          </div>
          <div class="step pending" id="step2" data-step="2" onclick="goToStep(2)">
            <div class="step-number">2</div>
            <span>Select Cities</span>
          </div>
          <div class="step pending" id="step3" data-step="3" onclick="goToStep(3)">
            <div class="step-number">3</div>
            <span>Share Memories</span>
          </div>
          <div class="step pending" id="step4" data-step="4" onclick="goToStep(4)">
            <div class="step-number">4</div>
            <span>Your Story</span>
          </div>
          <div class="step pending" id="step5" data-step="5" onclick="goToStep(5)">
            <div class="step-number">5</div>
            <span>Story Display</span>
          </div>
        </div>

        <!-- Step 1: Choose Country -->
        <div class="step-content active" id="step1-content">
          <h2>üåç Where have you traveled?</h2>
          <p>Start by telling us which country you'd like to document your memories from.</p>
          <div class="form-group">
            <label class="form-label">Country</label>
            <div class="autocomplete-container">
              <input type="text" class="form-input" id="countryInput" placeholder="e.g., Thailand, Japan, Italy..." autocomplete="off">
              <div class="autocomplete-dropdown" id="countryDropdown"></div>
            </div>
          </div>
          
          <!-- Date Input Section -->
          <div class="form-group">
            <label class="form-label">üìÖ When did you visit this country?</label>
            <div class="date-input-container">
              <div class="date-input-row">
                <div class="date-input-group">
                  <label class="date-label">Month</label>
                  <select class="form-input date-select" id="countryMonth">
                    <option value="">Select Month</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
                <div class="date-input-group">
                  <label class="date-label">Year</label>
                  <select class="form-input date-select" id="countryYear">
                    <option value="">Select Year</option>
                  </select>
                </div>
              </div>
              <div class="date-input-hint">üí° This helps us create more accurate and contextual stories</div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Cities you visited (add manually):</label>
            <div class="city-input-container">
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" class="form-input" id="manualCityInput" placeholder="e.g., Bangkok, Chiang Mai, Phuket (separate with commas)" onkeypress="if(event.key === 'Enter') addManualCities()">
                <button class="btn btn-secondary" type="button" onclick="addManualCities()">Add Cities</button>
              </div>
              <div class="city-input-hint">üí° Tip: You can enter multiple cities separated by commas (e.g., "Bangkok, Chiang Mai, Phuket")</div>
              <div class="city-tags" id="manualCitiesList"></div>
            </div>
          </div>
          
          <!-- Photo Upload Section -->
          <div class="form-group">
            <label class="form-label">üì∏ Add Photos (Optional)</label>
            <div class="photo-upload-section" id="photoUploadSection">
              <div class="photo-upload-icon">
                <i class="fas fa-camera"></i>
              </div>
              <div class="photo-upload-text">
                Drag and drop photos here or click to browse
              </div>
              <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
              <button class="photo-upload-btn" onclick="document.getElementById('photoInput').click()">
                <i class="fas fa-upload"></i>
                Choose Photos
              </button>
            </div>
            <div class="photo-preview" id="photoPreview"></div>
          </div>
          <button class="btn btn-primary" onclick="suggestCities()">
            <i class="fas fa-search"></i>
            Find Cities & Activities
          </button>
        </div>

        <!-- Step 2: Select Cities -->
        <div class="step-content" id="step2-content">
          <h2>üèôÔ∏è Which cities did you visit?</h2>
          <p>We've found some popular destinations. Select the cities you visited and we'll help you remember the details.</p>
          <div id="citiesContainer"></div>
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-primary" onclick="nextStep()" id="nextStepBtn" disabled>
              Continue
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Memory Prompts -->
        <div class="step-content" id="step3-content">
          <h2>üí≠ Let's jog your memory</h2>
          <p>Answer these questions about your time in the cities you visited. Don't worry about being perfect ‚Äî just share what you remember!</p>
          
          <!-- Test Button for Auto-fill -->
          <div class="form-group" style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border: 2px dashed #0ea5e9; border-radius: 8px;">
            <label class="form-label" style="color: #0c4a6e; font-weight: 600;">üß™ Testing Mode</label>
            <p style="color: #0369a1; margin-bottom: 10px; font-size: 14px;">Click this button to auto-fill all memory prompts with sample data for testing:</p>
            <button class="btn btn-secondary" onclick="autoFillMemoryPrompts()" style="background: #0ea5e9; color: white; border: none;">
              <i class="fas fa-magic"></i>
              Auto-fill Test Data
            </button>
          </div>
          
          <div class="form-group">
            <label class="form-label">Freeform memory (write anything you remember about your trip):</label>
            <textarea class="form-input" id="freeformMemory" placeholder="Write your memories here..."></textarea>
          </div>
          <div id="memoryPromptsContainer"></div>
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-primary" onclick="generateNarrative()">
              <i class="fas fa-magic"></i>
              Create My Story
            </button>
          </div>
        </div>

        <!-- Step 4: Story Generation -->
        <div class="step-content" id="step4-content">
          <div class="step-header">
            <h2>üìñ Generate Your Story</h2>
            <p>Choose your story style and let AI create your travel narrative</p>
          </div>

          <!-- Story Length Options -->
          <div class="story-length-section">
            <h3>Story Length</h3>
            <div class="story-length-options">
              <div class="length-option" onclick="selectStoryLength('quick')">
                <div class="length-icon">‚ö°</div>
                <div class="length-info">
                  <h4>Quick Summary</h4>
                  <p>2-3 paragraphs capturing the highlights</p>
                  <div class="length-badge">Short</div>
                </div>
              </div>
              <div class="length-option" onclick="selectStoryLength('detailed')">
                <div class="length-icon">üìù</div>
                <div class="length-info">
                  <h4>Detailed Narrative</h4>
                  <p>Comprehensive story with rich details</p>
                  <div class="length-badge">Medium</div>
                </div>
              </div>
              <div class="length-option" onclick="selectStoryLength('epic')">
                <div class="length-icon">üìö</div>
                <div class="length-info">
                  <h4>Epic Tale</h4>
                  <p>Full-length story with immersive storytelling</p>
                  <div class="length-badge">Long</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Story Layout Options -->
          <div class="story-layout-section">
            <h3>Story Layout</h3>
            <div class="layout-options">
              <div class="layout-option" onclick="selectLayout('classic')">
                <div class="layout-icon">üìñ</div>
                <div class="layout-content">
                  <div class="layout-title">Classic Travelogue</div>
                  <div class="layout-description">Traditional narrative with clear sections, perfect for sharing with family</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('journal')">
                <div class="layout-icon">üìù</div>
                <div class="layout-content">
                  <div class="layout-title">Personal Journal</div>
                  <div class="layout-description">Intimate, diary-style entries with your thoughts and feelings</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('poetic')">
                <div class="layout-icon">‚ú®</div>
                <div class="layout-content">
                  <div class="layout-title">Poetic & Lyrical</div>
                  <div class="layout-description">Beautiful, flowing prose that captures the magic of your journey</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('adventure')">
                <div class="layout-icon">üó∫Ô∏è</div>
                <div class="layout-content">
                  <div class="layout-title">Adventure Story</div>
                  <div class="layout-description">Exciting, action-packed narrative like a travel documentary</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('elegant')">
                <div class="layout-icon">üé≠</div>
                <div class="layout-content">
                  <div class="layout-title">Elegant & Sophisticated</div>
                  <div class="layout-description">Refined, sophisticated writing perfect for professional sharing</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Generate Story Button -->
          <div class="generate-story-section">
            <button class="btn btn-primary btn-large" onclick="generateNarrative()">
              <i class="fas fa-magic"></i>
              Generate My Story
            </button>
            <p class="generate-note">Your story will be created based on your selected length and layout preferences</p>
          </div>
          
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-success" onclick="saveStory()">
              <i class="fas fa-save"></i>
              Save Story
            </button>
          </div>
        </div>

        <!-- Step 5: Story Display -->
        <div class="step-content" id="step5-content">
          <div class="step-header">
            <h2>üìñ Your Travel Story</h2>
            <p>Here's your personalized travel narrative. Feel free to edit it or try different styles!</p>
          </div>
          
          <div class="narrative-preview">
            <div class="narrative-header">
              <h3>Your Travel Story</h3>
              <button class="btn btn-secondary btn-small" onclick="toggleEditMode()" id="editToggleBtn">
                <i class="fas fa-edit"></i>
                Edit Story
              </button>
            </div>
            <div class="narrative-text" id="narrativeText"></div>
            <textarea class="narrative-textarea hidden" id="narrativeTextarea" placeholder="Edit your story here..."></textarea>
          </div>
          
          <div class="style-buttons">
            <button class="btn-style active" onclick="changeStyle('original', this)">Original</button>
            <button class="btn-style" onclick="changeStyle('casual', this)">Casual & Funny</button>
            <button class="btn-style" onclick="changeStyle('poetic', this)">Poetic & Dreamy</button>
            <button class="btn-style" onclick="changeStyle('punchy', this)">Short & Punchy</button>
          </div>
          
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-success" onclick="saveStory()">
              <i class="fas fa-save"></i>
              Save Story
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>AI is working its magic...</p>
        </div>

        <!-- Error/Success Messages -->
        <div id="messageContainer"></div>
      </div>
    </div>

    <!-- My Stories Page -->
    <div class="page-content" id="stories-page">
      <div class="stories-header">
        <h1>üìö My Stories</h1>
        <p>Relive your travel memories</p>
        
        <!-- Search Bar -->
        <div class="search-container">
          <div class="search-input-wrapper">
            <span class="search-icon"><i class="fas fa-search"></i></span>
            <input type="text" id="storySearchInput" placeholder="Search stories, countries‚Ä¶" oninput="filterStories()" autocomplete="off" />
          </div>
        </div>
      </div>
      
      <div class="container">
        <div id="storiesContainer">
          <!-- Stories will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Story Detail Page -->
    <div class="page-content" id="storyDetailPage" style="display: none;">
      <div id="storyDetailContent">
        <!-- Story detail content will be populated here -->
      </div>
    </div>

    <!-- Map View Page -->
    <div class="page-content" id="map-page">
      <div class="map-header">
        <h1>üó∫Ô∏è Your Travel Map</h1>
        <p>See all the countries you've documented your travels in</p>
      </div>
      
      <div class="container">
        <div class="world-map-container">
          <div class="world-map" id="worldMap">
            <!-- Real SVG World Map -->
            <svg id="svgWorldMap" viewBox="0 0 1000 500" width="100%" height="500" xmlns="http://www.w3.org/2000/svg" style="background: #f8fafc; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.07);">
              <!-- World Map Paths - Simplified but recognizable countries -->
              <!-- North America -->
              <path id="United States" d="M150,150 L200,150 L200,200 L150,200 Z" class="country-shape" data-country="United States" />
              <path id="Canada" d="M150,100 L200,100 L200,150 L150,150 Z" class="country-shape" data-country="Canada" />
              <path id="Mexico" d="M150,200 L200,200 L200,250 L150,250 Z" class="country-shape" data-country="Mexico" />
              
              <!-- South America -->
              <path id="Brazil" d="M250,250 L300,250 L300,350 L250,350 Z" class="country-shape" data-country="Brazil" />
              <path id="Argentina" d="M250,350 L300,350 L300,400 L250,400 Z" class="country-shape" data-country="Argentina" />
              <path id="Peru" d="M200,250 L250,250 L250,300 L200,300 Z" class="country-shape" data-country="Peru" />
              <path id="Colombia" d="M200,200 L250,200 L250,250 L200,250 Z" class="country-shape" data-country="Colombia" />
              <path id="Chile" d="M200,300 L250,300 L250,400 L200,400 Z" class="country-shape" data-country="Chile" />
              
              <!-- Europe -->
              <path id="France" d="M450,150 L500,150 L500,200 L450,200 Z" class="country-shape" data-country="France" />
              <path id="Germany" d="M500,150 L550,150 L550,200 L500,200 Z" class="country-shape" data-country="Germany" />
              <path id="Italy" d="M500,200 L550,200 L550,250 L500,250 Z" class="country-shape" data-country="Italy" />
              <path id="Spain" d="M450,200 L500,200 L500,250 L450,250 Z" class="country-shape" data-country="Spain" />
              <path id="United Kingdom" d="M450,100 L500,100 L500,150 L450,150 Z" class="country-shape" data-country="United Kingdom" />
              <path id="Netherlands" d="M500,100 L550,100 L550,150 L500,150 Z" class="country-shape" data-country="Netherlands" />
              <path id="Switzerland" d="M500,150 L550,150 L550,200 L500,200 Z" class="country-shape" data-country="Switzerland" />
              <path id="Austria" d="M550,150 L600,150 L600,200 L550,200 Z" class="country-shape" data-country="Austria" />
              <path id="Poland" d="M550,100 L600,100 L600,150 L550,150 Z" class="country-shape" data-country="Poland" />
              <path id="Czech Republic" d="M550,150 L600,150 L600,200 L550,200 Z" class="country-shape" data-country="Czech Republic" />
              <path id="Hungary" d="M600,150 L650,150 L650,200 L600,200 Z" class="country-shape" data-country="Hungary" />
              <path id="Romania" d="M600,200 L650,200 L650,250 L600,250 Z" class="country-shape" data-country="Romania" />
              <path id="Bulgaria" d="M600,250 L650,250 L650,300 L600,300 Z" class="country-shape" data-country="Bulgaria" />
              <path id="Greece" d="M550,250 L600,250 L600,300 L550,300 Z" class="country-shape" data-country="Greece" />
              <path id="Turkey" d="M650,200 L700,200 L700,250 L650,250 Z" class="country-shape" data-country="Turkey" />
              
              <!-- Asia -->
              <path id="China" d="M750,150 L850,150 L850,250 L750,250 Z" class="country-shape" data-country="China" />
              <path id="Japan" d="M850,150 L900,150 L900,200 L850,200 Z" class="country-shape" data-country="Japan" />
              <path id="South Korea" d="M850,200 L900,200 L900,250 L850,250 Z" class="country-shape" data-country="South Korea" />
              <path id="India" d="M700,200 L750,200 L750,300 L700,300 Z" class="country-shape" data-country="India" />
              <path id="Thailand" d="M750,250 L800,250 L800,300 L750,300 Z" class="country-shape" data-country="Thailand" />
              <path id="Vietnam" d="M800,250 L850,250 L850,300 L800,300 Z" class="country-shape" data-country="Vietnam" />
              <path id="Cambodia" d="M800,300 L850,300 L850,350 L800,350 Z" class="country-shape" data-country="Cambodia" />
              <path id="Laos" d="M800,250 L850,250 L850,300 L800,300 Z" class="country-shape" data-country="Laos" />
              <path id="Myanmar" d="M750,250 L800,250 L800,300 L750,300 Z" class="country-shape" data-country="Myanmar" />
              <path id="Malaysia" d="M800,300 L850,300 L850,350 L800,350 Z" class="country-shape" data-country="Malaysia" />
              <path id="Singapore" d="M800,350 L850,350 L850,400 L800,400 Z" class="country-shape" data-country="Singapore" />
              <path id="Indonesia" d="M800,350 L850,350 L850,400 L800,400 Z" class="country-shape" data-country="Indonesia" />
              <path id="Philippines" d="M850,250 L900,250 L900,300 L850,300 Z" class="country-shape" data-country="Philippines" />
              <path id="Taiwan" d="M850,200 L900,200 L900,250 L850,250 Z" class="country-shape" data-country="Taiwan" />
              <path id="Russia" d="M650,50 L850,50 L850,150 L650,150 Z" class="country-shape" data-country="Russia" />
              <path id="Mongolia" d="M750,100 L800,100 L800,150 L750,150 Z" class="country-shape" data-country="Mongolia" />
              <path id="Kazakhstan" d="M700,100 L750,100 L750,150 L700,150 Z" class="country-shape" data-country="Kazakhstan" />
              <path id="Uzbekistan" d="M700,150 L750,150 L750,200 L700,200 Z" class="country-shape" data-country="Uzbekistan" />
              <path id="Iran" d="M700,200 L750,200 L750,250 L700,250 Z" class="country-shape" data-country="Iran" />
              <path id="Iraq" d="M700,250 L750,250 L750,300 L700,300 Z" class="country-shape" data-country="Iraq" />
              <path id="Saudi Arabia" d="M700,300 L750,300 L750,350 L700,350 Z" class="country-shape" data-country="Saudi Arabia" />
              <path id="United Arab Emirates" d="M750,300 L800,300 L800,350 L750,350 Z" class="country-shape" data-country="United Arab Emirates" />
              <path id="Qatar" d="M750,350 L800,350 L800,400 L750,400 Z" class="country-shape" data-country="Qatar" />
              <path id="Kuwait" d="M750,300 L800,300 L800,350 L750,350 Z" class="country-shape" data-country="Kuwait" />
              <path id="Oman" d="M750,350 L800,350 L800,400 L750,400 Z" class="country-shape" data-country="Oman" />
              <path id="Yemen" d="M750,400 L800,400 L800,450 L750,450 Z" class="country-shape" data-country="Yemen" />
              <path id="Israel" d="M700,250 L750,250 L750,300 L700,300 Z" class="country-shape" data-country="Israel" />
              <path id="Lebanon" d="M700,250 L750,250 L750,300 L700,300 Z" class="country-shape" data-country="Lebanon" />
              <path id="Jordan" d="M700,300 L750,300 L750,350 L700,350 Z" class="country-shape" data-country="Jordan" />
              <path id="Syria" d="M700,250 L750,250 L750,300 L700,300 Z" class="country-shape" data-country="Syria" />
              
              <!-- Africa -->
              <path id="Egypt" d="M600,300 L650,300 L650,350 L600,350 Z" class="country-shape" data-country="Egypt" />
              <path id="Morocco" d="M550,250 L600,250 L600,300 L550,300 Z" class="country-shape" data-country="Morocco" />
              <path id="Algeria" d="M550,300 L600,300 L600,350 L550,350 Z" class="country-shape" data-country="Algeria" />
              <path id="Tunisia" d="M600,300 L650,300 L650,350 L600,350 Z" class="country-shape" data-country="Tunisia" />
              <path id="Libya" d="M600,350 L650,350 L650,400 L600,400 Z" class="country-shape" data-country="Libya" />
              <path id="Sudan" d="M650,350 L700,350 L700,400 L650,400 Z" class="country-shape" data-country="Sudan" />
              <path id="Ethiopia" d="M700,350 L750,350 L750,400 L700,400 Z" class="country-shape" data-country="Ethiopia" />
              <path id="Kenya" d="M700,400 L750,400 L750,450 L700,450 Z" class="country-shape" data-country="Kenya" />
              <path id="Tanzania" d="M700,450 L750,450 L750,500 L700,500 Z" class="country-shape" data-country="Tanzania" />
              <path id="Uganda" d="M700,400 L750,400 L750,450 L700,450 Z" class="country-shape" data-country="Uganda" />
              <path id="Rwanda" d="M700,450 L750,450 L750,500 L700,500 Z" class="country-shape" data-country="Rwanda" />
              <path id="South Africa" d="M600,450 L650,450 L650,500 L600,500 Z" class="country-shape" data-country="South Africa" />
              <path id="Nigeria" d="M550,400 L600,400 L600,450 L550,450 Z" class="country-shape" data-country="Nigeria" />
              <path id="Ghana" d="M550,450 L600,450 L600,500 L550,500 Z" class="country-shape" data-country="Ghana" />
              <path id="Senegal" d="M500,400 L550,400 L550,450 L500,450 Z" class="country-shape" data-country="Senegal" />
              <path id="Mali" d="M550,400 L600,400 L600,450 L550,450 Z" class="country-shape" data-country="Mali" />
              <path id="Burkina Faso" d="M550,450 L600,450 L600,500 L550,500 Z" class="country-shape" data-country="Burkina Faso" />
              <path id="Niger" d="M600,400 L650,400 L650,450 L600,450 Z" class="country-shape" data-country="Niger" />
              <path id="Chad" d="M650,400 L700,400 L700,450 L650,450 Z" class="country-shape" data-country="Chad" />
              <path id="Cameroon" d="M600,450 L650,450 L650,500 L600,500 Z" class="country-shape" data-country="Cameroon" />
              <path id="Central African Republic" d="M650,450 L700,450 L700,500 L650,500 Z" class="country-shape" data-country="Central African Republic" />
              <path id="Democratic Republic of the Congo" d="M650,450 L700,450 L700,500 L650,500 Z" class="country-shape" data-country="Democratic Republic of the Congo" />
              <path id="Congo" d="M650,450 L700,450 L700,500 L650,500 Z" class="country-shape" data-country="Congo" />
              <path id="Gabon" d="M600,450 L650,450 L650,500 L600,500 Z" class="country-shape" data-country="Gabon" />
              <path id="Equatorial Guinea" d="M600,450 L650,450 L650,500 L600,500 Z" class="country-shape" data-country="Equatorial Guinea" />
              <path id="Sao Tome and Pr√≠ncipe" d="M600,450 L650,450 L650,500 L600,500 Z" class="country-shape" data-country="Sao Tome and Principe" />
              <path id="Angola" d="M600,450 L650,450 L650,500 L600,500 Z" class="country-shape" data-country="Angola" />
              <path id="Zambia" d="M650,450 L700,450 L700,500 L650,500 Z" class="country-shape" data-country="Zambia" />
              <path id="Zimbabwe" d="M650,450 L700,450 L700,500 L650,500 Z" class="country-shape" data-country="Zimbabwe" />
              <path id="Botswana" d="M650,450 L700,450 L700,500 L650,500 Z" class="country-shape" data-country="Botswana" />
              <path id="Namibia" d="M600,450 L650,450 L650,500 L600,500 Z" class="country-shape" data-country="Namibia" />
              <path id="Mozambique" d="M700,450 L750,450 L750,500 L700,500 Z" class="country-shape" data-country="Mozambique" />
              <path id="Madagascar" d="M750,450 L800,450 L800,500 L750,500 Z" class="country-shape" data-country="Madagascar" />
              <path id="Mauritius" d="M750,450 L800,450 L800,500 L750,500 Z" class="country-shape" data-country="Mauritius" />
              <path id="Seychelles" d="M750,450 L800,450 L800,500 L750,500 Z" class="country-shape" data-country="Seychelles" />
              <path id="Comoros" d="M750,450 L800,450 L800,500 L750,500 Z" class="country-shape" data-country="Comoros" />
              <path id="Somalia" d="M750,400 L800,400 L800,450 L750,450 Z" class="country-shape" data-country="Somalia" />
              <path id="Djibouti" d="M750,400 L800,400 L800,450 L750,450 Z" class="country-shape" data-country="Djibouti" />
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WanderLog AI ‚Äî Your Living Travel Memoir</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .tagline {
      font-size: 1.2rem;
      font-weight: 300;
      opacity: 0.9;
    }

    .main-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
      gap: 20px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .step.active {
      background: #667eea;
      color: white;
    }

    .step.completed {
      background: #10b981;
      color: white;
    }

    .step.pending {
      background: #f3f4f6;
      color: #6b7280;
    }

    .step:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .step.completed:hover {
      background: #059669;
    }

    .step.pending:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .step.active .step-number {
      background: rgba(255,255,255,0.2);
    }

    .step.completed .step-number {
      background: rgba(255,255,255,0.2);
    }

    .step.pending .step-number {
      background: #d1d5db;
    }

    .step.loading .step-number {
      background: #fbbf24;
      color: white;
    }

    .step.error .step-number {
      background: #ef4444;
      color: white;
    }

    .step-content {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .step-content.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }

    .form-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .cities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .city-card {
      border: 2px solid #e5e7eb;
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .city-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .city-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .city-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .city-activities {
      list-style: none;
      margin-top: 10px;
    }

    .city-activities li {
      padding: 5px 0;
      color: #6b7280;
      font-size: 14px;
    }

    .city-activities li:before {
      content: "üìç ";
      color: #667eea;
    }

    .memory-prompts {
      background: #f9fafb;
      border-radius: 15px;
      padding: 30px;
      margin-top: 20px;
    }

    .prompt-item {
      margin-bottom: 25px;
    }

    .prompt-question {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .prompt-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }

    .prompt-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .city-section {
      background: #f8fafc;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border-left: 4px solid #667eea;
    }

    .city-section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .city-section-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1f2937;
    }

    .city-section-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .refresh-btn {
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      color: #6b7280;
    }

    .refresh-btn:hover {
      border-color: #667eea;
      color: #667eea;
      background: #f0f4ff;
    }

    .prompt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .narrative-preview {
      background: #f0f4ff;
      border-radius: 15px;
      padding: 30px;
      margin-top: 20px;
      border-left: 5px solid #667eea;
    }

    .narrative-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .narrative-header h3 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1f2937;
    }

    .narrative-text {
      line-height: 1.8;
      color: #1f2937;
      font-size: 16px;
    }

    .narrative-textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
    }

    .style-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-style {
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-style:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .btn-style.active {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }

    .hidden {
      display: none;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      gap: 10px;
    }

    .nav-tab {
      padding: 15px 30px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-tab:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .nav-tab.active {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    /* Page Content */
    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
    }

    /* My Stories Page */
    .stories-header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .stories-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stories-header p {
      color: #fff;
      font-size: 1.18rem;
      font-weight: 500;
      margin-bottom: 30px;
      letter-spacing: 0.01em;
      text-shadow: 0 2px 8px rgba(60,60,100,0.10);
    }

    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .country-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
      min-width: 320px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .country-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      border-color: #667eea;
    }

    .country-card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .country-flag {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .country-info h3 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .country-info p {
      color: #6b7280;
      font-size: 14px;
    }

    .country-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .country-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      width: 100%;
      box-sizing: border-box;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
    }

    .btn-share {
      background: #8b5cf6;
      color: white;
    }

    .btn-share:hover {
      background: #7c3aed;
    }

    .share-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .share-modal.show {
      display: flex;
    }

    .share-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .share-modal-header h3 {
      margin: 0;
      color: #1f2937;
    }

    .share-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 5px;
    }

    .share-modal-close:hover {
      color: #374151;
    }

    .share-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .share-option {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .share-option:hover {
      border-color: #667eea;
      background: #f8fafc;
    }

    .share-option-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .share-option-text {
      flex: 1;
    }

    .share-option-text h4 {
      margin: 0 0 5px 0;
      color: #1f2937;
    }

    .share-option-text p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }

    .share-link {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .share-link input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .share-link input:focus {
      outline: none;
      border-color: #667eea;
    }

    .copy-btn {
      padding: 12px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    .copy-btn:hover {
      background: #5a67d8;
    }

    .copy-btn.copied {
      background: #10b981;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: white;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.7;
    }

    .empty-state h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 30px;
    }

    /* Photo Upload Styles */
    .photo-upload-section {
      margin-top: 15px;
      padding: 15px;
      border: 2px dashed #e5e7eb;
      border-radius: 8px;
      text-align: center;
      transition: all 0.3s ease;
      max-width: 400px;
    }

    .photo-upload-section:hover {
      border-color: #667eea;
      background: #f8fafc;
    }

    .photo-upload-section.dragover {
      border-color: #667eea;
      background: #eff6ff;
    }

    .photo-upload-icon {
      font-size: 1.5rem;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .photo-upload-text {
      color: #6b7280;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .photo-upload-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .photo-upload-btn:hover {
      background: #5a67d8;
    }

    .photo-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .photo-item {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .photo-item img {
      width: 100%;
      height: 80px;
      object-fit: cover;
    }

    .photo-remove {
      position: absolute;
      top: 3px;
      right: 3px;
      background: rgba(220, 38, 38, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .photo-remove:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
    }

    /* Layout Options Styles */
    .layout-options {
      margin: 20px 0;
      padding: 20px;
      display: flex;
      gap: 15px;
    }

    .layout-option {
      cursor: pointer;
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .layout-option:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .layout-option.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    .layout-preview {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .preview-line {
      height: 20px;
      background: #e5e7eb;
      margin-bottom: 5px;
    }

    .preview-line.short {
      width: 50px;
    }

    .preview-line.long {
      width: 100px;
    }

    .preview-line.classic-preview {
      background: #667eea;
    }

    .preview-line.journal-preview {
      background: #764ba2;
    }

    .preview-line.poetic-preview {
      background: #8b5cf6;
    }

    .preview-line.adventure-preview {
      background: #10b981;
    }

    .preview-line.elegant-preview {
      background: #f3f4f6;
    }

    /* Generate Story Section Styles */
    .generate-story-section {
      text-align: center;
      margin: 30px 0;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      color: white;
    }

    .generate-story-section .btn-large {
      padding: 16px 32px;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .generate-story-section .btn-large:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .generate-note {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }

    /* Profile Styles */
    .profile-header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .profile-settings {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .profile-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      flex: 1;
    }

    .profile-avatar {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .avatar-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #6b7280;
    }

    .avatar-upload-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .avatar-upload-btn:hover {
      background: #5a67d8;
    }

    .profile-info {
      text-align: center;
    }

    .profile-name-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .profile-name-input {
      width: 200px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }

    .profile-status {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(26px);
      -ms-transform: translateX(26px);
      transform: translateX(26px);
    }

    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    .status-text {
      font-size: 14px;
      color: #6b7280;
    }

    .profile-bio {
      margin-bottom: 20px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      text-align: left;
    }

    .profile-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .public-stories-section {
      margin-top: 40px;
    }

    .section-header {
      text-align: center;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .public-stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .public-story-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .public-story-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }

    .public-story-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .public-story-flag {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .public-story-info {
      flex: 1;
    }

    .public-story-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .public-story-summary {
      font-size: 14px;
      color: #6b7280;
    }

    .profile-link-section {
      text-align: center;
      margin-top: 40px;
    }

    .profile-link-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .profile-link-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .profile-link-input {
      width: 200px;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }

    .copy-profile-link-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .copy-profile-link-btn:hover {
      background: #5a67d8;
    }

    .profile-link-note {
      font-size: 14px;
      color: #6b7280;
      margin-top: 10px;
    }

    /* Public Button Styles */
    .btn-public {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-public:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .btn-public.private {
      background: #6b7280;
    }

    .btn-public.private:hover {
      background: #4b5563;
    }

    /* No Public Stories State */
    .no-public-stories {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
      grid-column: 1 / -1;
    }

    .no-public-stories i {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .no-public-stories h3 {
      margin-bottom: 10px;
      color: #374151;
    }

    /* Public Story Card Styles */
    .public-story-excerpt {
      margin: 15px 0;
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }

    .public-story-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .world-map svg {
      width: 100%;
      height: 400px;
      display: block;
    }
    .country-shape {
      fill: #e5e7eb;
      stroke: #cbd5e1;
      stroke-width: 2;
      cursor: pointer;
      transition: fill 0.2s, stroke 0.2s;
    }
    .country-shape.visited {
      fill: #667eea;
      stroke: #4338ca;
    }
    .country-shape:hover {
      fill: #a5b4fc;
      stroke: #6366f1;
    }

    /* Date Input Styles */
    .date-input-container {
      position: relative;
    }

    .date-input-row {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }

    .date-input-group {
      flex: 1;
    }

    .date-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 5px;
    }

    .date-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      background: white;
      transition: all 0.3s ease;
    }

    .date-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .date-input-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .date-input-row {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Export Button Styles */
    .btn-export {
      background: #059669;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-export:hover {
      background: #047857;
      transform: translateY(-2px);
    }

    /* Export Modal Styles */
    .export-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .export-modal.show {
      display: flex;
    }

    .export-modal-content {
      background: white;
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .export-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px 30px;
      border-bottom: 1px solid #e5e7eb;
    }

    .export-modal-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }

    .export-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .export-modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .export-options {
      padding: 30px;
    }

    .export-option {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .export-option:hover {
      border-color: #667eea;
      background: #f8fafc;
      transform: translateY(-2px);
    }

    .export-icon {
      font-size: 2rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      border-radius: 12px;
      flex-shrink: 0;
    }

    .export-info h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 5px 0;
    }

    .export-info p {
      color: #6b7280;
      margin: 0;
      font-size: 14px;
      line-height: 1.4;
    }

    .export-footer {
      padding: 20px 30px;
      border-top: 1px solid #e5e7eb;
      text-align: right;
    }

    @media (max-width: 768px) {
      .export-option {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .export-icon {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .step.loading {
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }
    
    .step.completed {
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
    
    .step.error {
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }

    .length-option {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .length-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .length-option.active {
      border-color: #667eea;
      background: #f0f4ff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .layout-option {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: flex-start;
      gap: 15px;
      min-width: 200px;
      flex: 1;
    }

    .layout-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .layout-option.active {
      border-color: #667eea;
      background: #f0f4ff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .layout-icon {
      font-size: 24px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .layout-content {
      flex: 1;
    }

    .layout-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .layout-description {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.4;
    }

    .layout-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    /* --- Modern Search Bar & Filter for My Stories --- */
    .search-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }
    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-input-wrapper input[type="text"] {
      padding: 10px 14px 10px 38px;
      border-radius: 24px;
      border: none;
      background: #f4f6fa;
      font-size: 1.08rem;
      box-shadow: 0 2px 8px 0 rgba(60,60,100,0.07);
      outline: none;
      transition: box-shadow 0.2s;
      min-width: 260px;
      color: #3b3663;
    }
    .search-input-wrapper input[type="text"]:focus {
      box-shadow: 0 4px 16px 0 rgba(60,60,100,0.13);
      background: #fff;
    }
    .search-input-wrapper .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #667eea;
      font-size: 1.3em;
      pointer-events: none;
    }
    .stories-filter {
      border-radius: 24px;
      border: none;
      background: #f4f6fa;
      font-size: 1.08rem;
      padding: 10px 36px 10px 16px;
      color: #3b3663;
      box-shadow: 0 2px 8px 0 rgba(60,60,100,0.07);
      outline: none;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23667eea" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px 20px;
      min-width: 100px;
      margin-left: 0;
    }
    .stories-filter:focus {
      box-shadow: 0 4px 16px 0 rgba(60,60,100,0.13);
      background: #fff;
    }
    @media (max-width: 600px) {
      .search-container {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      .search-input-wrapper input[type="text"], .stories-filter {
        min-width: 0;
        width: 100%;
      }
    }

    /* --- Modal Fixes for Story Detail Modal --- */
    .story-detail-modal {
      display: flex !important;
      opacity: 1 !important;
      z-index: 99999 !important;
      background: rgba(0,0,0,0.7) !important;
      border: 5px solid red !important;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
      opacity: 0;
    }
    .story-detail-modal.show {
      display: flex !important;
      opacity: 1;
      z-index: 99999;
    }
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .story-detail-modal-content {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 40px rgba(60,60,100,0.18);
      max-width: 600px;
      width: 95vw;
      padding: 32px 28px 24px 28px;
      position: relative;
      animation: modalPopIn 0.25s;
    }
    @keyframes modalPopIn {
      from { transform: scale(0.97) translateY(30px); }
      to { transform: scale(1) translateY(0); }
    }

    /* --- Guaranteed Modal Visibility --- */
    .story-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 999999;
      background: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .story-detail-modal.show {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
      background: rgba(0,0,0,0.95) !important;
      z-index: 9999999 !important;
    }

    .story-detail-modal-content {
      background: #fff !important;
      border: 6px solid #ff00cc !important;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
      position: relative;
    }

    .story-detail-modal-content::before {
      content: 'MODAL IS VISIBLE';
      display: block;
      background: #fff0f3;
      color: #ff0033;
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      padding: 24px 0 10px 0;
      border-bottom: 2px solid #ff00cc;
      margin-bottom: 18px;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .story-detail-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 25px 30px 20px;
      border-bottom: 1px solid #e8e8e8;
    }

    .story-detail-header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .story-country-flag {
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .story-detail-header-info h3 {
      margin: 0 0 5px 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #3b3663;
    }

    .story-detail-header-info p {
      margin: 0;
      color: #7b7b93;
      font-size: 1rem;
    }

    .story-detail-modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: #7b7b93;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .story-detail-modal-close:hover {
      background: #f8f9fa;
      color: #3b3663;
    }

    .story-detail-content {
      padding: 25px 30px;
    }

    .story-detail-photos {
      margin-bottom: 25px;
    }

    .story-detail-narrative {
      margin-bottom: 25px;
    }

    .story-detail-narrative h4 {
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #3b3663;
    }

    .story-narrative-text {
      line-height: 1.6;
      color: #4a4a4a;
      font-size: 1rem;
    }

    .story-detail-cities h4 {
      margin: 0 0 15px 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: #3b3663;
    }

    .story-cities-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .story-cities-list span {
      background: #f0f2f5;
      color: #3b3663;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .story-detail-actions {
      display: flex;
      gap: 12px;
      padding: 20px 30px 25px;
      border-top: 1px solid #e8e8e8;
      flex-wrap: wrap;
    }

    .story-detail-actions .btn {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .story-detail-actions .btn-primary {
      background: #6366f1;
      color: white;
    }

    .story-detail-actions .btn-primary:hover {
      background: #5855eb;
    }

    .story-detail-actions .btn-secondary {
      background: #f8f9fa;
      color: #3b3663;
      border: 1px solid #e8e8e8;
    }

    .story-detail-actions .btn-secondary:hover {
      background: #e9ecef;
    }

    .story-detail-actions .btn-export {
      background: #10b981;
      color: white;
    }

    .story-detail-actions .btn-export:hover {
      background: #059669;
    }

    .story-detail-actions .btn-danger {
      background: #ef4444;
      color: white;
    }

    .story-detail-actions .btn-danger:hover {
      background: #dc2626;
    }

    @media (max-width: 768px) {
      .story-detail-modal {
        padding: 10px;
      }
      
      .story-detail-modal-content {
        max-height: 95vh;
      }
      
      .story-detail-modal-header {
        padding: 20px 20px 15px;
      }
      
      .story-detail-content {
        padding: 20px;
      }
      
      .story-detail-actions {
        padding: 15px 20px 20px;
        flex-direction: column;
      }
      
      .story-detail-actions .btn {
        width: 100%;
      }
    }

    /* Story Detail Page Styles */
    .story-detail-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .story-detail-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .back-button {
      background: #f3f4f6;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-button:hover {
      background: #e5e7eb;
      transform: translateX(-2px);
    }

    .story-title h1 {
      margin: 0;
      font-size: 2.5rem;
      color: #1f2937;
    }

    .story-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 8px;
    }

    .story-meta .flag {
      font-size: 2rem;
    }

    .story-meta .date {
      color: #6b7280;
      font-size: 1.1rem;
    }

    .story-detail-body {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .story-narrative h2,
    .story-cities h3,
    .story-photos h3 {
      color: #1f2937;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .story-narrative p {
      line-height: 1.8;
      color: #374151;
      font-size: 1.1rem;
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .cities-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .cities-list .city-tag {
      background: #667eea;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .photo-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .photo-item img:hover {
      transform: scale(1.05);
    }

    .story-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
    }

    .story-actions .btn {
      padding: 12px 24px;
      font-size: 14px;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-globe-americas"></i>
        WanderLog AI
      </div>
      <div class="tagline">
        Remember everywhere you've been. Write the story you never had time to record.
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('create', event)">
        <i class="fas fa-plus"></i>
        Create Story
      </button>
      <button class="nav-tab" onclick="showPage('stories', event)">
        <i class="fas fa-book-open"></i>
        My Stories
      </button>
      <button class="nav-tab" onclick="showPage('map', event)">
        <i class="fas fa-map-marked-alt"></i>
        Map View
      </button>
      <button class="nav-tab" onclick="showPage('profile', event)">
        <i class="fas fa-user-circle"></i>
        Public Profile
      </button>
      <button class="nav-tab" onclick="clearStoryData()" style="background: #ef4444; color: white;">
        <i class="fas fa-trash"></i>
        Clear Data
      </button>
    </div>

    <!-- Create Story Page -->
    <div class="page-content active" id="create-page">
      <div class="main-content">
        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step active" id="step1" data-step="1" onclick="goToStep(1)">
            <div class="step-number">1</div>
            <span>Choose Country</span>
          </div>
          <div class="step pending" id="step2" data-step="2" onclick="goToStep(2)">
            <div class="step-number">2</div>
            <span>Select Cities</span>
          </div>
          <div class="step pending" id="step3" data-step="3" onclick="goToStep(3)">
            <div class="step-number">3</div>
            <span>Share Memories</span>
          </div>
          <div class="step pending" id="step4" data-step="4" onclick="goToStep(4)">
            <div class="step-number">4</div>
            <span>Your Story</span>
          </div>
          <div class="step pending" id="step5" data-step="5" onclick="goToStep(5)">
            <div class="step-number">5</div>
            <span>Story Display</span>
          </div>
        </div>

        <!-- Step 1: Choose Country -->
        <div class="step-content active" id="step1-content">
          <h2>üåç Where have you traveled?</h2>
          <p>Start by telling us which country you'd like to document your memories from.</p>
          <div class="form-group">
            <label class="form-label">Country</label>
            <div class="autocomplete-container">
              <input type="text" class="form-input" id="countryInput" placeholder="e.g., Thailand, Japan, Italy..." autocomplete="off">
              <div class="autocomplete-dropdown" id="countryDropdown"></div>
            </div>
          </div>
          
          <!-- Date Input Section -->
          <div class="form-group">
            <label class="form-label">üìÖ When did you visit this country?</label>
            <div class="date-input-container">
              <div class="date-input-row">
                <div class="date-input-group">
                  <label class="date-label">Month</label>
                  <select class="form-input date-select" id="countryMonth">
                    <option value="">Select Month</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
                <div class="date-input-group">
                  <label class="date-label">Year</label>
                  <select class="form-input date-select" id="countryYear">
                    <option value="">Select Year</option>
                  </select>
                </div>
              </div>
              <div class="date-input-hint">üí° This helps us create more accurate and contextual stories</div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Cities you visited (add manually):</label>
            <div class="city-input-container">
              <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" class="form-input" id="manualCityInput" placeholder="e.g., Bangkok, Chiang Mai, Phuket (separate with commas)" onkeypress="if(event.key === 'Enter') addManualCities()">
                <button class="btn btn-secondary" type="button" onclick="addManualCities()">Add Cities</button>
              </div>
              <div class="city-input-hint">üí° Tip: You can enter multiple cities separated by commas (e.g., "Bangkok, Chiang Mai, Phuket")</div>
              <div class="city-tags" id="manualCitiesList"></div>
            </div>
          </div>
          
          <!-- Photo Upload Section -->
          <div class="form-group">
            <label class="form-label">üì∏ Add Photos (Optional)</label>
            <div class="photo-upload-section" id="photoUploadSection">
              <div class="photo-upload-icon">
                <i class="fas fa-camera"></i>
              </div>
              <div class="photo-upload-text">
                Drag and drop photos here or click to browse
              </div>
              <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
              <button class="photo-upload-btn" onclick="document.getElementById('photoInput').click()">
                <i class="fas fa-upload"></i>
                Choose Photos
              </button>
            </div>
            <div class="photo-preview" id="photoPreview"></div>
          </div>
          <button class="btn btn-primary" onclick="suggestCities()">
            <i class="fas fa-search"></i>
            Find Cities & Activities
          </button>
        </div>

        <!-- Step 2: Select Cities -->
        <div class="step-content" id="step2-content">
          <h2>üèôÔ∏è Which cities did you visit?</h2>
          <p>We've found some popular destinations. Select the cities you visited and we'll help you remember the details.</p>
          <div id="citiesContainer"></div>
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-primary" onclick="nextStep()" id="nextStepBtn" disabled>
              Continue
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Memory Prompts -->
        <div class="step-content" id="step3-content">
          <h2>üí≠ Let's jog your memory</h2>
          <p>Answer these questions about your time in the cities you visited. Don't worry about being perfect ‚Äî just share what you remember!</p>
          
          <!-- Test Button for Auto-fill -->
          <div class="form-group" style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border: 2px dashed #0ea5e9; border-radius: 8px;">
            <label class="form-label" style="color: #0c4a6e; font-weight: 600;">üß™ Testing Mode</label>
            <p style="color: #0369a1; margin-bottom: 10px; font-size: 14px;">Click this button to auto-fill all memory prompts with sample data for testing:</p>
            <button class="btn btn-secondary" onclick="autoFillMemoryPrompts()" style="background: #0ea5e9; color: white; border: none;">
              <i class="fas fa-magic"></i>
              Auto-fill Test Data
            </button>
          </div>
          
          <div class="form-group">
            <label class="form-label">Freeform memory (write anything you remember about your trip):</label>
            <textarea class="form-input" id="freeformMemory" placeholder="Write your memories here..."></textarea>
          </div>
          <div id="memoryPromptsContainer"></div>
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-primary" onclick="generateNarrative()">
              <i class="fas fa-magic"></i>
              Create My Story
            </button>
          </div>
        </div>

        <!-- Step 4: Story Generation -->
        <div class="step-content" id="step4-content">
          <div class="step-header">
            <h2>üìñ Generate Your Story</h2>
            <p>Choose your story style and let AI create your travel narrative</p>
          </div>

          <!-- Story Length Options -->
          <div class="story-length-section">
            <h3>Story Length</h3>
            <div class="story-length-options">
              <div class="length-option" onclick="selectStoryLength('quick')">
                <div class="length-icon">‚ö°</div>
                <div class="length-info">
                  <h4>Quick Summary</h4>
                  <p>2-3 paragraphs capturing the highlights</p>
                  <div class="length-badge">Short</div>
                </div>
              </div>
              <div class="length-option" onclick="selectStoryLength('detailed')">
                <div class="length-icon">üìù</div>
                <div class="length-info">
                  <h4>Detailed Narrative</h4>
                  <p>Comprehensive story with rich details</p>
                  <div class="length-badge">Medium</div>
                </div>
              </div>
              <div class="length-option" onclick="selectStoryLength('epic')">
                <div class="length-icon">üìö</div>
                <div class="length-info">
                  <h4>Epic Tale</h4>
                  <p>Full-length story with immersive storytelling</p>
                  <div class="length-badge">Long</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Story Layout Options -->
          <div class="story-layout-section">
            <h3>Story Layout</h3>
            <div class="layout-options">
              <div class="layout-option" onclick="selectLayout('classic')">
                <div class="layout-icon">üìñ</div>
                <div class="layout-content">
                  <div class="layout-title">Classic Travelogue</div>
                  <div class="layout-description">Traditional narrative with clear sections, perfect for sharing with family</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('journal')">
                <div class="layout-icon">üìù</div>
                <div class="layout-content">
                  <div class="layout-title">Personal Journal</div>
                  <div class="layout-description">Intimate, diary-style entries with your thoughts and feelings</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('poetic')">
                <div class="layout-icon">‚ú®</div>
                <div class="layout-content">
                  <div class="layout-title">Poetic & Lyrical</div>
                  <div class="layout-description">Beautiful, flowing prose that captures the magic of your journey</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('adventure')">
                <div class="layout-icon">üó∫Ô∏è</div>
                <div class="layout-content">
                  <div class="layout-title">Adventure Story</div>
                  <div class="layout-description">Exciting, action-packed narrative like a travel documentary</div>
                </div>
              </div>
              
              <div class="layout-option" onclick="selectLayout('elegant')">
                <div class="layout-icon">üé≠</div>
                <div class="layout-content">
                  <div class="layout-title">Elegant & Sophisticated</div>
                  <div class="layout-description">Refined, sophisticated writing perfect for professional sharing</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Generate Story Button -->
          <div class="generate-story-section">
            <button class="btn btn-primary btn-large" onclick="generateNarrative()">
              <i class="fas fa-magic"></i>
              Generate My Story
            </button>
            <p class="generate-note">Your story will be created based on your selected length and layout preferences</p>
          </div>
          
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-success" onclick="saveStory()">
              <i class="fas fa-save"></i>
              Save Story
            </button>
          </div>
        </div>

        <!-- Step 5: Story Display -->
        <div class="step-content" id="step5-content">
          <div class="step-header">
            <h2>üìñ Your Travel Story</h2>
            <p>Here's your personalized travel narrative. Feel free to edit it or try different styles!</p>
          </div>
          
          <div class="narrative-preview">
            <div class="narrative-header">
              <h3>Your Travel Story</h3>
              <button class="btn btn-secondary btn-small" onclick="toggleEditMode()" id="editToggleBtn">
                <i class="fas fa-edit"></i>
                Edit Story
              </button>
            </div>
            <div class="narrative-text" id="narrativeText"></div>
            <textarea class="narrative-textarea hidden" id="narrativeTextarea" placeholder="Edit your story here..."></textarea>
          </div>
          
          <div class="style-buttons">
            <button class="btn-style active" onclick="changeStyle('original', this)">Original</button>
            <button class="btn-style" onclick="changeStyle('casual', this)">Casual & Funny</button>
            <button class="btn-style" onclick="changeStyle('poetic', this)">Poetic & Dreamy</button>
            <button class="btn-style" onclick="changeStyle('punchy', this)">Short & Punchy</button>
          </div>
          
          <div class="navigation">
            <button class="btn btn-secondary" onclick="previousStep()">
              <i class="fas fa-arrow-left"></i>
              Back
            </button>
            <button class="btn btn-success" onclick="saveStory()">
              <i class="fas fa-save"></i>
              Save Story
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>AI is working its magic...</p>
        </div>

        <!-- Error/Success Messages -->
        <div id="messageContainer"></div>
      </div>
    </div>

    <!-- My Stories Page -->
    <div class="page-content" id="stories-page">
      <div class="stories-header">
        <h1>üìö My Stories</h1>
        <p>Relive your travel memories</p>
        
        <!-- Search Bar -->
        <div class="search-container">
          <div class="search-input-wrapper">
            <span class="search-icon"><i class="fas fa-search"></i></span>
            <input type="text" id="storySearchInput" placeholder="Search stories, countries‚Ä¶" oninput="filterStories()" autocomplete="off" />
          </div>
        </div>
      </div>
      
      <div class="container">
        <div id="storiesContainer">
          <!-- Stories will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Story Detail Page -->
    <div class="page-content" id="storyDetailPage" style="display: none;">
      <div id="storyDetailContent">
        <!-- Story detail content will be populated here -->
      </div>
    </div>

    <!-- Map View Page -->
    <div class="page-content" id="map-page">
      <div class="map-header">
        <h1>üó∫Ô∏è Your Travel Map</h1>
        <p>See all the countries you've documented your travels in</p>
      </div>
      
      <div class="container">
        <div class="world-map-container">
          <div class="world-map" id="worldMap">
            <!-- World map will be rendered here -->
            <svg id="svgWorldMap" viewBox="0 0 2000 1001" width="100%" height="400" xmlns="http://www.w3.org/2000/svg" style="background:white; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.07);">
              <!-- Example: Add a few country paths for demo, real map would have all countries -->
              <path id="United States" d="M300,300 L400,300 L400,400 L300,400 Z" class="country-shape" />
              <path id="Canada" d="M300,200 L400,200 L400,300 L300,300 Z" class="country-shape" />
              <path id="Brazil" d="M700,600 L800,600 L800,700 L700,700 Z" class="country-shape" />
              <path id="France" d="M1100,400 L1150,400 L1150,450 L1100,450 Z" class="country-shape" />
              <path id="India" d="M1500,600 L1550,600 L1550,650 L1500,650 Z" class="country-shape" />
              <!-- ... (add all countries for full map) ... -->
            </svg>
          </div>
          <div class="map-legend">
            <h3>Legend</h3>
            <div class="legend-item">
              <div class="legend-color visited"></div>
              <span>Countries with stories</span>
            </div>
            <div class="legend-item">
              <div class="legend-color not-visited"></div>
              <span>Countries without stories</span>
            </div>
          </div>
        </div>
        
        <div class="map-stats">
          <div class="stat-card">
            <div class="stat-number" id="totalCountries">0</div>
            <div class="stat-label">Countries Visited</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalStories">0</div>
            <div class="stat-label">Total Stories</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalCities">0</div>
            <div class="stat-label">Cities Documented</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Public Profile Page -->
    <div class="page-content" id="profile-page">
      <div class="profile-header">
        <h1>üë§ Your Public Travel Profile</h1>
        <p>Share your travel adventures with the world</p>
      </div>
      
      <div class="container">
        <!-- Profile Settings -->
        <div class="profile-settings">
          <div class="profile-card">
            <div class="profile-avatar">
              <div class="avatar-placeholder">
                <i class="fas fa-user"></i>
              </div>
              <button class="avatar-upload-btn">
                <i class="fas fa-camera"></i>
              </button>
            </div>
            
            <div class="profile-info">
              <div class="profile-name-section">
                <input type="text" class="profile-name-input" id="profileName" placeholder="Your Travel Name" value="Wanderer">
                <div class="profile-status">
                  <label class="switch">
                    <input type="checkbox" id="profilePublic" checked>
                    <span class="slider round"></span>
                  </label>
                  <span class="status-text">Public Profile</span>
                </div>
              </div>
              
    <!-- Share Modal -->
    <div class="share-modal" id="shareModal">
      <div class="share-modal-content">
        <div class="share-modal-header">
          <h3>Share Your Travel Story</h3>
          <button class="share-modal-close" onclick="closeShareModal()">&times;</button>
        </div>
        
        <div class="share-options">
          <div class="share-option" onclick="shareViaEmail()">
            <div class="share-option-icon" style="background: #ea4335;">
              <i class="fas fa-envelope"></i>
            </div>
            <div class="share-option-text">
              <h4>Email</h4>
              <p>Send via email</p>
            </div>
          </div>
          
          <div class="share-option" onclick="shareViaWhatsApp()">
            <div class="share-option-icon" style="background: #25d366;">
              <i class="fab fa-whatsapp"></i>
            </div>
            <div class="share-option-text">
              <h4>WhatsApp</h4>
              <p>Share on WhatsApp</p>
            </div>
          </div>
          
          <div class="share-option" onclick="shareViaTwitter()">
            <div class="share-option-icon" style="background: #1da1f2;">
              <i class="fab fa-twitter"></i>
            </div>
            <div class="share-option-text">
              <h4>Twitter</h4>
              <p>Share on Twitter</p>
            </div>
          </div>
          
          <div class="share-option" onclick="shareViaFacebook()">
            <div class="share-option-icon" style="background: #1877f2;">
              <i class="fab fa-facebook"></i>
            </div>
            <div class="share-option-text">
              <h4>Facebook</h4>
              <p>Share on Facebook</p>
            </div>
          </div>
        </div>
        
        <div class="share-link">
          <input type="text" id="shareLinkInput" readonly placeholder="Share link will appear here...">
          <button class="copy-btn" onclick="copyShareLink()" id="copyBtn">
            <i class="fas fa-copy"></i>
            Copy
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Story Detail Modal -->
  <div id="storyDetailModal" class="story-detail-modal">
    <div class="story-detail-modal-content">
      <div class="story-detail-modal-header">
        <div class="story-detail-header-info">
          <div class="story-country-flag" id="storyDetailFlag">üåç</div>
          <div>
            <h3 id="storyDetailCountry">Country</h3>
            <p id="storyDetailDate">Date</p>
          </div>
        </div>
        <button class="story-detail-modal-close" onclick="closeStoryDetailModal()">√ó</button>
      </div>
      
      <div class="story-detail-content">
        <div class="story-detail-photos" id="storyDetailPhotos">
          <!-- Photos will be loaded here -->
        </div>
        
        <div class="story-detail-narrative">
          <h4>Your Travel Story</h4>
          <div class="story-narrative-text" id="storyDetailNarrative">
            <!-- Story text will be loaded here -->
          </div>
        </div>
        
        <div class="story-detail-cities">
          <h4>Cities Visited</h4>
          <div class="story-cities-list" id="storyDetailCities">
            <!-- Cities will be loaded here -->
          </div>
        </div>
      </div>
      
      <div class="story-detail-actions">
        <button class="btn btn-primary" onclick="editStory()">
          <i class="fas fa-edit"></i>
          Edit Story
        </button>
        <button class="btn btn-secondary" onclick="shareStory()">
          <i class="fas fa-share-alt"></i>
          Share Story
        </button>
        <button class="btn btn-export" onclick="showExportOptions()">
          <i class="fas fa-download"></i>
          Export
        </button>
        <button class="btn btn-danger" onclick="deleteStory()">
          <i class="fas fa-trash"></i>
          Delete Story
        </button>
      </div>
    </div>
  </div>

  <div class="loading-modal" id="loadingModal">
    <div class="loading-modal-content">
      <div class="spinner"></div>
      <p class="loading-text">AI is working its magic...</p>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="export-modal" id="exportModal">
    <div class="export-modal-content">
      <div class="export-modal-header">
        <h3>üì§ Export Your Story</h3>
        <button class="export-modal-close" onclick="closeExportModal()">&times;</button>
      </div>
      
      <div class="export-options">
        <div class="export-option" onclick="exportAsPDF()">
          <div class="export-icon">üìÑ</div>
          <div class="export-info">
            <h4>PDF Document</h4>
            <p>Download as a beautifully formatted PDF with photos and text</p>
          </div>
        </div>
        
        <div class="export-option" onclick="exportAsDigitalAlbum()">
          <div class="export-icon">üì∏</div>
          <div class="export-info">
            <h4>Digital Album</h4>
            <p>Create a photo album with captions and story text</p>
          </div>
        </div>
        
        <div class="export-option" onclick="exportForSocialMedia()">
          <div class="export-icon">üì±</div>
          <div class="export-info">
            <h4>Social Media Ready</h4>
            <p>Generate optimized content for Instagram, Facebook, or Twitter</p>
          </div>
        </div>
        
        <div class="export-option" onclick="exportAsText()">
          <div class="export-icon">üìù</div>
          <div class="export-info">
            <h4>Plain Text</h4>
            <p>Simple text format for easy copying and pasting</p>
          </div>
        </div>
      </div>
      
      <div class="export-footer">
        <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- TEMP: Button to force show modal for debugging -->
  <button onclick="showStoryDetailModal(savedStories[0])" style="position:fixed;bottom:10px;right:10px;z-index:10000;background:#e0e;border-radius:8px;padding:8px 16px;">[DEBUG] Show Modal</button>

  <!-- DEBUG: Guaranteed Modal Block -->
  <div id="debugModal" style="display: flex !important; opacity: 1 !important; z-index: 999999 !important; background: rgba(0,0,0,0.9) !important; border: 10px solid #ff0000 !important; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: auto !important;">
    <div style="background: #ff0000; color: #ffffff; font-size: 3rem; font-weight: bold; padding: 60px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px #ff0000; border: 5px solid #ffffff;">
      üö® DEBUG MODAL IS VISIBLE üö®<br><br>
      <span style="font-size: 1.5rem;">If you can see this, the modal system works!</span><br><br>
      <button onclick="this.closest('#debugModal').style.display='none'" style="margin-top: 20px; font-size: 1.5rem; padding: 15px 30px; border-radius: 12px; border: none; background: #ffffff; color: #ff0000; cursor: pointer; font-weight: bold;">CLOSE DEBUG MODAL</button>
    </div>
  </div>

  <script>
    // Test alert to verify page is loading
    alert('PAGE IS LOADING! If you see this, the HTML file is working.');
    
    // Debug modal visibility
    console.log('Checking for debug modal...');
    const debugModal = document.getElementById('debugModal');
    if (debugModal) {
      console.log('Debug modal found!');
      console.log('Modal display style:', debugModal.style.display);
      console.log('Modal opacity:', debugModal.style.opacity);
      console.log('Modal z-index:', debugModal.style.zIndex);
      alert('DEBUG MODAL FOUND! Check console for details.');
    } else {
      console.log('Debug modal NOT found!');
      alert('DEBUG MODAL NOT FOUND! This is the problem.');
    }
    
    // Global variables
    let currentStep = 1;
    let selectedCities = [];
    let manualCities = [];
    let aiSuggestedCities = [];
    let userAnswers = [];
    let generatedNarrative = '';
    let savedStories = [];
    let currentCityData = {};
    let selectedStoryLength = 'medium';
    let selectedStoryLayout = 'narrative';
    let countryPhotos = {};
    let currentStyle = 'original';
    let currentStory = null;
    let currentView = 'main'; // 'main' or 'story-detail'
    
    // Complete list of countries for autocomplete
    const countries = [
      'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan',
      'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan', 'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi',
      'Cabo Verde', 'Cambodia', 'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic',
      'Democratic Republic of the Congo', 'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic',
      'Ecuador', 'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia',
      'Fiji', 'Finland', 'France',
      'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana',
      'Haiti', 'Honduras', 'Hungary',
      'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy', 'Ivory Coast',
      'Jamaica', 'Japan', 'Jordan',
      'Kazakhstan', 'Kenya', 'Kiribati', 'Kuwait', 'Kyrgyzstan',
      'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Luxembourg',
      'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar',
      'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia', 'Norway',
      'Oman',
      'Pakistan', 'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal',
      'Qatar',
      'Romania', 'Russia', 'Rwanda',
      'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino', 'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa', 'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria',
      'Taiwan', 'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Tuvalu',
      'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan',
      'Vanuatu', 'Vatican City', 'Venezuela', 'Vietnam',
      'Yemen',
      'Zambia', 'Zimbabwe'
    ];

    // API endpoint (replace with your actual endpoint)
    const API_ENDPOINT = 'http://localhost:8080';

    // Page Navigation
    function showPage(pageName, evt) {
      // Hide all pages
      document.querySelectorAll('.page-content').forEach(page => {
        page.classList.remove('active');
      });
      
      // Show selected page
      const pageElem = document.getElementById(pageName + '-page');
      if (pageElem) {
        pageElem.classList.add('active');
      }
      
      // Update tab states only if evt and evt.target exist
      if (evt && evt.target) {
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        evt.target.classList.add('active');
      }
      
      // Load stories if showing stories page
      if (pageName === 'stories') {
        loadStories();
      }
      
      // Load map if showing map page
      if (pageName === 'map') {
        loadMapView();
      }
      
      // Load profile if showing profile page
      if (pageName === 'profile') {
        initPublicProfile();
      }
    }

    // Initialize autocomplete for country input
    function initCountryAutocomplete() {
      const input = document.getElementById('countryInput');
      const dropdown = document.getElementById('countryDropdown');
      let selectedIndex = -1;

      input.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        const filteredCountries = countries.filter(country => 
          country.toLowerCase().includes(value)
        );

        if (value.length > 0 && filteredCountries.length > 0) {
          showDropdown(filteredCountries);
        } else {
          hideDropdown();
        }
        selectedIndex = -1;
      });

      input.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelection(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelection(items);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            selectCountry(items[selectedIndex].textContent);
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          hideDropdown();
        }
      });
    }

    function showDropdown(countries) {
      const dropdown = document.getElementById('countryDropdown');
      dropdown.innerHTML = countries.map(country => 
        `<div class="autocomplete-item" onclick="selectCountry('${country}')">${country}</div>`
      ).join('');
      dropdown.classList.add('show');
    }

    function hideDropdown() {
      const dropdown = document.getElementById('countryDropdown');
      dropdown.classList.remove('show');
    }

    function updateSelection(items) {
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function selectCountry(country) {
      document.getElementById('countryInput').value = country;
      hideDropdown();
    }

    // Load and display map view
    async function loadMapView() {
      showLoading();
      try {
        // Load stories if not already loaded
        if (savedStories.length === 0) {
          const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: 'get_stories'
            })
          });
          
          const data = await response.json();
          if (response.ok && data.stories) {
            savedStories = data.stories;
          }
        }

        // Get unique countries from stories
        const visitedCountries = [...new Set(savedStories.map(story => story.country))];
        
        // Update stats
        document.getElementById('totalCountries').textContent = visitedCountries.length;
        document.getElementById('totalStories').textContent = savedStories.length;
        const totalCities = savedStories.reduce((sum, story) => {
          if (story.cities && Array.isArray(story.cities)) {
            return sum + story.cities.length;
          }
          return sum + 1; // Fallback to 1 city per story
        }, 0);
        document.getElementById('totalCities').textContent = totalCities;

        // Render world map
        renderWorldMap(visitedCountries);
      } catch (error) {
        showMessage('Failed to load map data.');
        console.error('Error:', error);
      } finally {
        hideLoading();
      }
    }

    // Render world map with visited countries highlighted
    async function renderWorldMap(visitedCountries) {
      const mapContainer = document.getElementById('worldMap');
      try {
        // Fetch the real SVG world map
        const response = await fetch('world-map.svg');
        const svgText = await response.text();
        // Parse and inject SVG
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
        const svgElement = svgDoc.querySelector('svg');
        if (svgElement) {
          // Style for countries
          const style = document.createElement('style');
          style.textContent = `
            .country-shape { fill: #e5e7eb; stroke: #d1d5db; stroke-width: 1; transition: fill 0.3s; cursor: pointer; }
            .country-shape.visited { fill: #10b981; stroke: #059669; }
            .country-shape:hover { fill: #6366f1; }
            .country-shape.visited:hover { fill: #34d399; }
          `;
          svgElement.appendChild(style);
          // Highlight visited countries
          const paths = svgElement.querySelectorAll('path');
          paths.forEach(path => {
            if (path.id && visitedCountries.includes(path.id)) {
              path.classList.add('country-shape', 'visited');
            } else if (path.id) {
              path.classList.add('country-shape');
            }
            // Show info on click
            path.onclick = () => showCountryInfo(path.id);
          });
          mapContainer.innerHTML = '';
          mapContainer.appendChild(svgElement);
          document.getElementById('visitedCount').textContent = visitedCountries.length;
        }
      } catch (e) {
        mapContainer.innerHTML = '<div style=\"color:#b91c1c\">Failed to load map.</div>';
      }
    }    // Show country info when clicking on map
    function showCountryInfo(country) {
      const countryStories = savedStories.filter(story => story.country === country);
      if (countryStories.length > 0) {
        showStoryDetailModal(countryStories[0]);
      } else {
        showMessage(`No stories found for ${country}.`, 'info');
      }
    }

    // Load and display saved stories
    async function loadStories() {
      showLoading();
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'get_stories'
          })
        });
        
        const data = await response.json();
        if (response.ok && data.stories) {
          savedStories = data.stories;
          filteredStories = [...savedStories]; // Initialize filtered stories
          displayStories();
        } else {
          showMessage(data.error || 'Failed to load stories.');
          displayEmptyState();
        }
      } catch (error) {
        showMessage('Network error. Please try again.');
        console.error('Error:', error);
        displayEmptyState();
      } finally {
        hideLoading();
      }
    }

    // Display stories in country cards
    function displayStories() {
      const container = document.getElementById('storiesContainer');
      const searchTerm = document.getElementById('storySearchInput').value.toLowerCase().trim();
      
      if (filteredStories.length === 0) {
        if (savedStories.length === 0) {
          displayEmptyState();
        } else {
          displayNoResults();
        }
        return;
      }

      // Group stories by country
      const storiesByCountry = {};
      filteredStories.forEach(story => {
        if (!storiesByCountry[story.country]) {
          storiesByCountry[story.country] = [];
        }
        storiesByCountry[story.country].push(story);
      });

      // Create country cards
      const cardsHTML = Object.entries(storiesByCountry).map(([country, stories]) => {
        const totalCities = stories.length;
        const totalWords = stories.reduce((sum, story) => sum + story.narrative.split(' ').length, 0);
        const latestStory = stories[stories.length - 1];
        const flagEmoji = getCountryFlag(country);
        
        // Highlight country name if it matches search
        const highlightedCountry = searchTerm ? highlightSearchTerm(country, searchTerm) : country;
        
        // Get visit date information
        const visitDates = stories
          .map(story => story.visit_date)
          .filter(date => date)
          .map(date => {
            try {
              // Handle both "MM/YYYY" and "YYYY-MM-DD" formats
              let month, year;
              if (date.includes('/')) {
                // Format: "MM/YYYY"
                [month, year] = date.split('/');
              } else if (date.includes('-')) {
                // Format: "YYYY-MM-DD" or "YYYY-MM"
                const parts = date.split('-');
                if (parts.length >= 2) {
                  year = parts[0];
                  month = parts[1];
                } else {
                  return date; // Return as-is if can't parse
                }
              } else {
                return date; // Return as-is if can't parse
              }
              
              const monthNames = {
                '01': 'Jan', '02': 'Feb', '03': 'Mar', '04': 'Apr',
                '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Aug',
                '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dec'
              };
              return `${monthNames[month] || month} ${year}`;
            } catch {
              return date;
            }
          });
        
        const uniqueDates = [...new Set(visitDates)];
        const dateDisplay = uniqueDates.length > 0 ? 
          `<p><i class="fas fa-calendar"></i> ${uniqueDates.join(', ')}</p>` : '';
        
        // Collect all photos from stories in this country
        const allPhotos = [];
        stories.forEach(story => {
          if (story.photos && Array.isArray(story.photos)) {
            allPhotos.push(...story.photos);
          }
        });
        
        // Get up to 3 photos for preview
        const previewPhotos = allPhotos.slice(0, 3);
        const photoCount = allPhotos.length;
        
        return `
          <div class="country-card" onclick="onCountryCardClick(event, '${country}')">
            <div class="country-card-header">
              <div class="country-flag">${flagEmoji}</div>
              <div class="country-info">
                <h3>${highlightedCountry}</h3>
                <p>${totalCities} ${totalCities === 1 ? 'city' : 'cities'} documented</p>
                ${dateDisplay}
                ${photoCount > 0 ? `<p><i class="fas fa-camera"></i> ${photoCount} photo${photoCount === 1 ? '' : 's'}</p>` : ''}
              </div>
            </div>
            
            ${previewPhotos.length > 0 ? `
              <div class="country-photos">
                ${previewPhotos.map(photo => `
                  <div class="country-photo-preview">
                    <img src="${photo.data}" alt="${photo.name}" loading="lazy">
                  </div>
                `).join('')}
                ${photoCount > 3 ? `<div class="photo-overlay">+${photoCount - 3}</div>` : ''}
              </div>
            ` : ''}
            
            <div class="country-stats">
              <div class="stat">
                <div class="stat-number">${totalCities}</div>
                <div class="stat-label">Cities</div>
              </div>
              <div class="stat">
                <div class="stat-number">${totalWords}</div>
                <div class="stat-label">Words</div>
              </div>
              <div class="stat">
                <div class="stat-number">${stories.length}</div>
                <div class="stat-label">Stories</div>
              </div>
            </div>
            <div class="country-actions">
              <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); viewCountryStories('${country}')">
                <i class="fas fa-eye"></i>
                View Stories
              </button>
              <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); addToCountry('${country}')">
                <i class="fas fa-plus"></i>
                Add More
              </button>
              <button class="btn btn-share btn-small" onclick="event.stopPropagation(); shareCountryStories('${country}')">
                <i class="fas fa-share-alt"></i>
                Share
              </button>
              <button class="btn btn-public btn-small" onclick="event.stopPropagation(); toggleCountryPublic('${country}')" title="${stories.some(s => s.isPublic) ? 'Make Private' : 'Make Public'}">
                <i class="fas ${stories.some(s => s.isPublic) ? 'fa-eye-slash' : 'fa-globe'}"></i>
                ${stories.some(s => s.isPublic) ? 'Private' : 'Public'}
              </button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="stories-grid">
          ${cardsHTML}
        </div>
      `;
    }

    // Display no results state
    function displayNoResults() {
      const container = document.getElementById('storiesContainer');
      const searchTerm = document.getElementById('storySearchInput').value;
      container.innerHTML = `
        <div class="no-results">
          <i class="fas fa-search"></i>
          <h3>No stories found</h3>
          <p>No stories match "${searchTerm}". Try different keywords or check your spelling.</p>
          <button class="btn btn-secondary" onclick="clearSearch()">
            <i class="fas fa-times"></i>
            Clear Search
          </button>
        </div>
      `;
    }

    // Display empty state when no stories exist
    function displayEmptyState() {
      const container = document.getElementById('storiesContainer');
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-book-open"></i>
          <h2>No stories yet</h2>
          <p>Start documenting your travels by creating your first story!</p>
          <button class="btn btn-primary" onclick="showPage('create')">
            <i class="fas fa-plus"></i>
            Create Your First Story
          </button>
        </div>
      `;
    }

    // Get country flag emoji (simple mapping)
    function getCountryFlag(country) {
      const flagMap = {
        'Test Country': 'üè≥Ô∏è',
        'Thailand': 'üáπüá≠',
        'Japan': 'üáØüáµ',
        'Italy': 'üáÆüáπ',
        'France': 'üá´üá∑',
        'Spain': 'üá™üá∏',
        'Germany': 'üá©üá™',
        'Netherlands': 'üá≥üá±',
        'Belgium': 'üáßüá™',
        'Switzerland': 'üá®üá≠',
        'Austria': 'üá¶üáπ',
        'Greece': 'üá¨üá∑',
        'Portugal': 'üáµüáπ',
        'Ireland': 'üáÆüá™',
        'United Kingdom': 'üá¨üáß',
        'Scotland': 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø',
        'Wales': 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø',
        'Norway': 'üá≥üá¥',
        'Sweden': 'üá∏üá™',
        'Denmark': 'üá©üá∞',
        'Finland': 'üá´üáÆ',
        'Iceland': 'üáÆüá∏',
        'Canada': 'üá®üá¶',
        'United States': 'üá∫üá∏',
        'Mexico': 'üá≤üáΩ',
        'Brazil': 'üáßüá∑',
        'Argentina': 'üá¶üá∑',
        'Chile': 'üá®üá±',
        'Peru': 'üáµüá™',
        'Colombia': 'üá®üá¥',
        'Ecuador': 'üá™üá®',
        'Australia': 'üá¶üá∫',
        'New Zealand': 'üá≥üáø',
        'India': 'üáÆüá≥',
        'China': 'üá®üá≥',
        'South Korea': 'üá∞üá∑',
        'Vietnam': 'üáªüá≥',
        'Cambodia': 'üá∞üá≠',
        'Laos': 'üá±üá¶',
        'Myanmar': 'üá≤üá≤',
        'Malaysia': 'üá≤üáæ',
        'Singapore': 'üá∏üá¨',
        'Indonesia': 'üáÆüá©',
        'Philippines': 'üáµüá≠',
        'Taiwan': 'üáπüáº',
        'Hong Kong': 'üá≠üá∞',
        'South Africa': 'üáøüá¶',
        'Kenya': 'üá∞üá™',
        'Tanzania': 'üáπüáø',
        'Uganda': 'üá∫üá¨',
        'Rwanda': 'üá∑üáº',
        'Morocco': 'üá≤üá¶',
        'Egypt': 'üá™üá¨',
        'Tunisia': 'üáπüá≥',
        'Algeria': 'üá©üáø',
        'Turkey': 'üáπüá∑',
        'Israel': 'üáÆüá±',
        'Jordan': 'üáØüá¥',
        'Lebanon': 'üá±üáß',
        'Syria': 'üá∏üáæ',
        'Iraq': 'üáÆüá∂',
        'Iran': 'üáÆüá∑',
        'Afghanistan': 'üá¶üá´',
        'Pakistan': 'üáµüá∞',
        'Bangladesh': 'üáßüá©',
        'Sri Lanka': 'üá±üá∞',
        'Nepal': 'üá≥üáµ',
        'Bhutan': 'üáßüáπ',
        'Maldives': 'üá≤üáª',
        'Mongolia': 'üá≤üá≥',
        'Kazakhstan': 'üá∞üáø',
        'Uzbekistan': 'üá∫üáø',
        'Kyrgyzstan': 'üá∞üá¨',
        'Tajikistan': 'üáπüáØ',
        'Turkmenistan': 'üáπüá≤',
        'Azerbaijan': 'üá¶üáø',
        'Georgia': 'üá¨üá™',
        'Armenia': 'üá¶üá≤',
        'Ukraine': 'üá∫üá¶',
        'Belarus': 'üáßüáæ',
        'Poland': 'üáµüá±',
        'Czech Republic': 'üá®üáø',
        'Slovakia': 'üá∏üá∞',
        'Hungary': 'üá≠üá∫',
        'Romania': 'üá∑üá¥',
        'Bulgaria': 'üáßüá¨',
        'Croatia': 'üá≠üá∑',
        'Slovenia': 'üá∏üáÆ',
        'Serbia': 'üá∑üá∏',
        'Bosnia and Herzegovina': 'üáßüá¶',
        'Montenegro': 'üá≤üá™',
        'Albania': 'üá¶üá±',
        'North Macedonia': 'üá≤üá∞',
        'Kosovo': 'üáΩüá∞',
        'Moldova': 'üá≤üá©',
        'Estonia': 'üá™üá™',
        'Latvia': 'üá±üáª',
        'Lithuania': 'üá±üáπ',
        'Russia': 'üá∑üá∫',
        'Belize': 'üáßüáø',
        'Guatemala': 'üá¨üáπ',
        'El Salvador': 'üá∏üáª',
        'Honduras': 'üá≠üá≥',
        'Nicaragua': 'üá≥üáÆ',
        'Costa Rica': 'üá®üá∑',
        'Panama': 'üáµüá¶',
        'Cuba': 'üá®üá∫',
        'Jamaica': 'üáØüá≤',
        'Haiti': 'üá≠üáπ',
        'Dominican Republic': 'üá©üá¥',
        'Puerto Rico': 'üáµüá∑',
        'Trinidad and Tobago': 'üáπüáπ',
        'Barbados': 'üáßüáß',
        'Grenada': 'üá¨üá©',
        'Saint Lucia': 'üá±üá®',
        'Saint Vincent and the Grenadines': 'üáªüá®',
        'Antigua and Barbuda': 'üá¶üá¨',
        'Saint Kitts and Nevis': 'üá∞üá≥',
        'Dominica': 'üá©üá≤',
        'Bahamas': 'üáßüá∏',
        'Guyana': 'üá¨üáæ',
        'Suriname': 'üá∏üá∑',
        'French Guiana': 'üá¨üá´',
        'Venezuela': 'üáªüá™',
        'Bolivia': 'üáßüá¥',
        'Paraguay': 'üáµüáæ',
        'Uruguay': 'üá∫üáæ',
        'Fiji': 'üá´üáØ',
        'Papua New Guinea': 'üáµüá¨',
        'Solomon Islands': 'üá∏üáß',
        'Vanuatu': 'üáªüá∫',
        'New Caledonia': 'üá≥üá®',
        'French Polynesia': 'üáµüá´',
        'Samoa': 'üáºüá∏',
        'Tonga': 'üáπüá¥',
        'Kiribati': 'üá∞üáÆ',
        'Tuvalu': 'üáπüáª',
        'Nauru': 'üá≥üá∑',
        'Palau': 'üáµüáº',
        'Micronesia': 'üá´üá≤',
        'Marshall Islands': 'üá≤üá≠',
        'Cook Islands': 'üá®üá∞',
        'Niue': 'üá≥üá∫',
        'Tokelau': 'üáπüá∞',
        'Wallis and Futuna': 'üáºüá´',
        'American Samoa': 'üá¶üá∏',
        'Guam': 'üá¨üá∫',
        'Northern Mariana Islands': 'üá≤üáµ',
        'Palestine': 'üáµüá∏',
        'Western Sahara': 'üá™üá≠',
        'Somalia': 'üá∏üá¥',
        'Djibouti': 'üá©üáØ',
        'Eritrea': 'üá™üá∑',
        'Ethiopia': 'üá™üáπ',
        'Sudan': 'üá∏üá©',
        'South Sudan': 'üá∏üá∏',
        'Central African Republic': 'üá®üá´',
        'Cameroon': 'üá®üá≤',
        'Gabon': 'üá¨üá¶',
        'Republic of the Congo': 'üá®üá¨',
        'Democratic Republic of the Congo': 'üá®üá©',
        'Angola': 'üá¶üá¥',
        'Zambia': 'üáøüá≤',
        'Zimbabwe': 'üáøüáº',
        'Botswana': 'üáßüáº',
        'Namibia': 'üá≥üá¶',
        'Lesotho': 'üá±üá∏',
        'Eswatini': 'üá∏üáø',
        'Madagascar': 'üá≤üá¨',
        'Comoros': 'üá∞üá≤',
        'Mauritius': 'üá≤üá∫',
        'Seychelles': 'üá∏üá®',
        'Cape Verde': 'üá®üáª',
        'Guinea-Bissau': 'üá¨üáº',
        'Guinea': 'üá¨üá≥',
        'Sierra Leone': 'üá∏üá±',
        'Liberia': 'üá±üá∑',
        'Ivory Coast': 'üá®üáÆ',
        'Ghana': 'üá¨üá≠',
        'Togo': 'üáπüá¨',
        'Benin': 'üáßüáØ',
        'Nigeria': 'üá≥üá¨',
        'Niger': 'üá≥üá™',
        'Burkina Faso': 'üáßüá´',
        'Mali': 'üá≤üá±',
        'Mauritania': 'üá≤üá∑',
        'Senegal': 'üá∏üá≥',
        'Gambia': 'üá¨üá≤',
        'Chad': 'üáπüá©',
        'Equatorial Guinea': 'üá¨üá∂',
        'S√£o Tom√© and Pr√≠ncipe': 'üá∏üáπ',
        'Burundi': 'üáßüáÆ',
        'Malawi': 'üá≤üáº',
        'Mozambique': 'üá≤üáø',
        'Timor-Leste': 'üáπüá±',
        'Brunei': 'üáßüá≥',
        'Kuwait': 'üá∞üáº',
        'Qatar': 'üá∂üá¶',
        'United Arab Emirates': 'üá¶üá™',
        'Oman': 'üá¥üá≤',
        'Yemen': 'üáæüá™',
        'Saudi Arabia': 'üá∏üá¶',
        'Bahrain': 'üáßüá≠',
        'Cyprus': 'üá®üáæ',
        'Malta': 'üá≤üáπ',
        'Iceland': 'üáÆüá∏',
        'Faroe Islands': 'üá´üá¥',
        'Greenland': 'üá¨üá±',
        'Monaco': 'üá≤üá®',
        'Liechtenstein': 'üá±üáÆ',
        'San Marino': 'üá∏üá≤',
        'Vatican City': 'üáªüá¶',
        'Andorra': 'üá¶üá©',
        'Luxembourg': 'üá±üá∫',
        'Moldova': 'üá≤üá©',
        'Kosovo': 'üáΩüá∞',
        'North Macedonia': 'üá≤üá∞',
        'Albania': 'üá¶üá±',
        'Montenegro': 'üá≤üá™',
        'Bosnia and Herzegovina': 'üáßüá¶',
        'Slovenia': 'üá∏üáÆ',
        'Croatia': 'üá≠üá∑',
        'Serbia': 'üá∑üá∏',
        'Bulgaria': 'üáßüá¨',
        'Romania': 'üá∑üá¥',
        'Hungary': 'üá≠üá∫',
        'Slovakia': 'üá∏üá∞',
        'Czech Republic': 'üá®üáø',
        'Poland': 'üáµüá±',
        'Belarus': 'üáßüáæ',
        'Ukraine': 'üá∫üá¶',
        'Armenia': 'üá¶üá≤',
        'Georgia': 'üá¨üá™',
        'Azerbaijan': 'üá¶üáø',
        'Turkmenistan': 'üáπüá≤',
        'Tajikistan': 'üáπüáØ',
        'Kyrgyzstan': 'üá∞üá¨',
        'Uzbekistan': 'üá∫üáø',
        'Kazakhstan': 'üá∞üáø',
        'Mongolia': 'üá≤üá≥',
        'Maldives': 'üá≤üáª',
        'Bhutan': 'üáßüáπ',
        'Nepal': 'üá≥üáµ',
        'Sri Lanka': 'üá±üá∞',
        'Bangladesh': 'üáßüá©',
        'Pakistan': 'üáµüá∞',
        'Lithuania': 'üá±üáπ'
      };
      
      return flagMap[country] || 'üåç';
    }

    // Format visit date for display
    function formatVisitDate(dateString) {
      if (!dateString) return '';
      
      try {
        // Handle both "MM/YYYY" and "YYYY-MM-DD" formats
        let month, year;
        if (dateString.includes('/')) {
          // Format: "MM/YYYY"
          [month, year] = dateString.split('/');
        } else if (dateString.includes('-')) {
          // Format: "YYYY-MM-DD" or "YYYY-MM"
          const parts = dateString.split('-');
          if (parts.length >= 2) {
            year = parts[0];
            month = parts[1];
          } else {
            return dateString; // Return as-is if can't parse
          }
        } else {
          return dateString; // Return as-is if can't parse
        }
        
        const monthNames = {
          '01': 'January', '02': 'February', '03': 'March', '04': 'April',
          '05': 'May', '06': 'June', '07': 'July', '08': 'August',
          '09': 'September', '10': 'October', '11': 'November', '12': 'December'
        };
        return `${monthNames[month] || month} ${year}`;
      } catch {
        return dateString;
      }
    }

    // View stories for a specific country
    function viewCountryStories(country) {
      console.log('viewCountryStories called for', country); // Debug log
      const countryStories = savedStories.filter(story => story.country === country);
      if (countryStories.length > 0) {
        // Show the first story in the modal
        const story = countryStories[0];
        showStoryDetailModal(story);
      }
    }

    // Show story detail modal
    function showStoryDetailModal(story) {
      // Instead of modal, navigate to story detail view
      showStoryDetailPage(story);
    }
    
    // Show story detail page
    function showStoryDetailPage(story) {
      // Hide all pages and show story detail
      document.querySelectorAll('.page-content').forEach(page => {
        page.style.display = 'none';
      });
      document.getElementById('storyDetailPage').style.display = 'block';
      
      // Populate story detail content
      populateStoryDetailContent(story);
    }
    
    // Populate story detail content
    function populateStoryDetailContent(story) {
      const container = document.getElementById('storyDetailContent');
      
      const flag = getCountryFlag(story.country);
      const visitDate = formatVisitDate(story.visit_date);
      
      container.innerHTML = `
        <div class="story-detail-container">
          <div class="story-detail-header">
            <button onclick="backToMainPage()" class="back-button">
              <i class="fas fa-arrow-left"></i> Back to My Stories
            </button>
            <div class="story-title">
              <h1>${story.country}</h1>
              <div class="story-meta">
                <span class="flag">${flag}</span>
                <span class="date">${visitDate}</span>
              </div>
            </div>
          </div>
          
          <div class="story-detail-body">
            <div class="story-narrative">
              <h2>Your Travel Story</h2>
              <p>${story.narrative || 'No narrative available'}</p>
            </div>
            
            <div class="story-cities">
              <h3>Cities Visited</h3>
              <div class="cities-list">
                ${story.cities ? story.cities.map(city => `<span class="city-tag">${city}</span>`).join('') : '<p>No cities recorded</p>'}
              </div>
            </div>
            
            <div class="story-photos">
              <h3>Photos</h3>
              <div class="photos-grid">
                ${story.photos && story.photos.length > 0 ? 
                  story.photos.map(photo => `
                    <div class="photo-item">
                      <img src="${photo.data || photo}" alt="Travel photo" loading="lazy">
                    </div>
                  `).join('') : 
                  '<p style="color: #7b7b93; font-style: italic;">No photos available</p>'
                }
              </div>
            </div>
            
            <div class="story-actions">
              <button onclick="editStory()" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Story
              </button>
              <button onclick="shareStory()" class="btn btn-secondary">
                <i class="fas fa-share-alt"></i> Share Story
              </button>
              <button onclick="deleteStory()" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete Story
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    // Back to main page
    function backToMainPage() {
      // Show the stories page again
      showPage('stories');
    }
    
    // Close the story detail modal
    function closeStoryDetailModal() {
      const modal = document.getElementById('storyDetailModal');
      if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
      }
    }
    
    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('storyDetailModal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeStoryDetailModal();
          }
        });
      }
    });

    // Edit story function
    function editStory() {
      if (window.currentStoryDetail) {
        // Close modal and navigate to create page with story data
        closeStoryDetailModal();
        showPage('create');
        // TODO: Pre-populate form with story data
        showMessage('Edit functionality coming soon!', 'success');
      }
    }

    // Share story function
    function shareStory() {
      if (window.currentStoryDetail) {
        // Use existing share functionality
        shareCountryStories(window.currentStoryDetail.country);
      }
    }

    // Delete story function
    function deleteStory() {
      if (window.currentStoryDetail && confirm('Are you sure you want to delete this story? This action cannot be undone.')) {
        // TODO: Implement delete functionality
        showMessage('Delete functionality coming soon!', 'success');
        closeStoryDetailModal();
      }
    }

    // Add more stories to an existing country
    function addToCountry(country) {
      showPage('create');
      document.getElementById('countryInput').value = country;
      // You could also pre-populate with existing cities
    }

    function showLoading(message = 'Loading...') {
      const loadingModal = document.getElementById('loadingModal');
      const loadingText = loadingModal.querySelector('.loading-text');
      if (loadingText) {
        loadingText.textContent = message;
      }
      loadingModal.classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingModal').classList.remove('show');
    }

    function showMessage(message, type = 'error') {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    function addManualCities() {
      const input = document.getElementById('manualCityInput');
      const citiesText = input.value.trim();
      
      if (!citiesText) return;
      
      // Split by commas and clean up
      const newCities = citiesText.split(',')
        .map(city => city.trim())
        .filter(city => city && city.length > 0);
      
      // Add new cities that aren't already in the list
      newCities.forEach(city => {
        if (!manualCities.includes(city)) {
          manualCities.push(city);
        }
      });
      
      // Clear input and update display
      input.value = '';
      renderManualCities();
      updateURL();
    }

    function removeManualCity(city) {
      manualCities = manualCities.filter(c => c !== city);
      renderManualCities();
      updateURL();
    }

    function renderManualCities() {
      const list = document.getElementById('manualCitiesList');
      if (manualCities.length === 0) {
        list.innerHTML = '';
        return;
      }
      
      list.innerHTML = manualCities.map(city => `
        <div class="city-tag">
          <span>${city}</span>
          <button class="city-tag-remove" onclick="removeManualCity('${city}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');
    }

    // Helper function to normalize city names (remove accents and convert to lowercase)
    function normalizeCityName(cityName) {
      return cityName
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remove diacritics/accents
        .trim();
    }

    // Helper function to check if cities are the same (accent-insensitive)
    function citiesAreSame(city1, city2) {
      return normalizeCityName(city1) === normalizeCityName(city2);
    }

    async function suggestCities() {
      const country = document.getElementById('countryInput').value.trim();
      if (!country) {
        showMessage('Please enter a country name.');
        return;
      }
      
      // Show loading with specific message and progress indicator
      showLoading('Finding cities and activities for ' + country + '...');
      updateStepProgress(1, 'loading');
      
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'suggest_cities',
            country: country
          })
        });
        const data = await response.json();
        
        let aiCities = [];
        if (response.ok && data.cities) {
          aiCities = data.cities;
          
          // Store AI-suggested cities separately
          aiSuggestedCities = aiCities.map(city => ({ city: city.city, activities: city.activities || [] }));
        } else {
          showMessage(data.error || 'Failed to get city suggestions.');
        }
        
        // Filter out AI cities that are already in manual cities (accent-insensitive)
        const filteredAiCities = aiCities.filter(aiCity => {
          return !manualCities.some(manualCity => citiesAreSame(aiCity.city, manualCity));
        });
        
        // Combine manual and filtered AI cities
        const allCities = [
          ...manualCities.map(city => ({ city, activities: [] })),
          ...filteredAiCities
        ];
        
        // Store the city data for later use
        currentCityData = { cities: aiCities };
        
        displayCities(allCities);
        
        // Show success message before moving to next step
        showMessage(`Found ${allCities.length} cities for ${country}!`, 'success');
        updateStepProgress(1, 'completed');
        
        // Small delay to show the success message, then move to next step
        setTimeout(() => {
          nextStep();
        }, 1000);
        
      } catch (error) {
        showMessage('Network error. Please try again.');
        console.error('Error:', error);
        updateStepProgress(1, 'error');
      } finally {
        hideLoading();
      }
    }

    function displayCities(cities) {
      const container = document.getElementById('citiesContainer');
      container.innerHTML = '';

      cities.forEach(city => {
        const cityCard = document.createElement('div');
        cityCard.className = 'city-card';
        cityCard.onclick = () => toggleCitySelection(city);
        
        cityCard.innerHTML = `
          <div class="city-name">${city.city}</div>
          <ul class="city-activities">
            ${city.activities.map(activity => `<li>${activity}</li>`).join('')}
          </ul>
        `;
        
        container.appendChild(cityCard);
      });
    }

    function toggleCitySelection(city) {
      const cityCard = event.currentTarget;
      const isSelected = cityCard.classList.contains('selected');
      
      if (isSelected) {
        cityCard.classList.remove('selected');
        selectedCities = selectedCities.filter(c => c.city !== city.city);
      } else {
        cityCard.classList.add('selected');
        selectedCities.push(city);
      }
      
      document.getElementById('nextStepBtn').disabled = selectedCities.length === 0;
    }

    function nextStep() {
      if (currentStep < 5) {
        // Before moving to next step, combine cities from both sources
        if (currentStep === 2) {
          combineAllCities();
        }
        
        currentStep++;
        updateStepIndicator();
        showCurrentStep();
        
        // Generate memory prompts when moving to step 3
        if (currentStep === 3) {
          generateMemoryPrompts();
        }
      }
    }

    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepIndicator();
        showCurrentStep();
      }
    }

    function goToStep(stepNumber) {
      // Validate step number
      if (stepNumber < 1 || stepNumber > 5) return;
      
      // Check if we can navigate to this step based on current progress
      if (stepNumber > currentStep) {
        // Only allow navigation to next step if current step is complete
        if (stepNumber === currentStep + 1) {
          // Check if current step has required data
          if (currentStep === 1 && !document.getElementById('countryInput').value.trim()) {
            showMessage('Please select a country first.');
            return;
          }
          if (currentStep === 2 && selectedCities.length === 0) {
            showMessage('Please select at least one city first.');
            return;
          }
          if (currentStep === 3 && userAnswers.length === 0) {
            showMessage('Please answer at least one question or write a memory first.');
            return;
          }
          if (currentStep === 4 && !currentStory) {
            showMessage('Please generate your story first.');
            return;
          }
        } else {
          showMessage('Please complete the current step before proceeding.');
          return;
        }
      }
      
      currentStep = stepNumber;
      updateStepIndicator();
      showCurrentStep();
      
      // Generate memory prompts when moving to step 3
      if (currentStep === 3 && selectedCities.length > 0) {
        generateMemoryPrompts();
      }
    }

    function updateStepIndicator() {
      for (let i = 1; i <= 5; i++) {
        const step = document.getElementById(`step${i}`);
        if (i < currentStep) {
          step.className = 'step completed';
        } else if (i === currentStep) {
          step.className = 'step active';
        } else {
          step.className = 'step pending';
        }
      }
    }

    // New function to update step progress with visual indicators
    function updateStepProgress(step, status) {
      const stepElement = document.querySelector(`.step[data-step="${step}"]`);
      if (!stepElement) return;
      
      // Remove existing status classes
      stepElement.classList.remove('loading', 'completed', 'error');
      
      // Add new status class
      stepElement.classList.add(status);
      
      // Update step number with appropriate icon
      const stepNumber = stepElement.querySelector('.step-number');
      if (stepNumber) {
        switch (status) {
          case 'loading':
            stepNumber.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            stepElement.style.background = '#fbbf24'; // Yellow background for loading
            break;
          case 'completed':
            stepNumber.innerHTML = '<i class="fas fa-check"></i>';
            stepElement.style.background = '#10b981'; // Green background for completed
            break;
          case 'error':
            stepNumber.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            stepElement.style.background = '#ef4444'; // Red background for error
            break;
          default:
            stepNumber.textContent = step;
            stepElement.style.background = ''; // Reset background
        }
      }
      
      // Add a visual pulse animation for loading state
      if (status === 'loading') {
        stepElement.style.animation = 'pulse 1.5s infinite';
      } else {
        stepElement.style.animation = '';
      }
    }

    function showCurrentStep() {
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`step${currentStep}-content`).classList.add('active');
      
      // Redisplay cities if we're on step 2
      if (currentStep === 2) {
        // Reconstruct the cities list
        let allCities = [];
        
        // Add manual cities
        if (manualCities.length > 0) {
          allCities.push(...manualCities.map(city => ({ city, activities: [] })));
        }
        
        // Add AI cities if available
        if (currentCityData && currentCityData.cities) {
          const aiCities = currentCityData.cities;
          
          const filteredAiCities = aiCities.filter(aiCity => {
            return !manualCities.some(manualCity => citiesAreSame(aiCity.city, manualCity));
          });
          
          allCities.push(...filteredAiCities);
        }
        
        if (allCities.length > 0) {
          displayCities(allCities);
        } else {
          // Show a message that no cities are available
          const container = document.getElementById('citiesContainer');
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-city"></i>
              <h3>No cities found</h3>
              <p>Try clicking "Find Cities & Activities" again or add cities manually.</p>
              <button class="btn btn-primary" onclick="suggestCities()">
                <i class="fas fa-search"></i>
                Find Cities Again
              </button>
            </div>
          `;
        }
      }
    }

    async function generateMemoryPrompts() {
      if (selectedCities.length === 0) {
        return;
      }

      showLoading('Generating memory prompts for your selected cities...');
      updateStepProgress(3, 'loading');

      try {
        const container = document.getElementById('memoryPromptsContainer');
        container.innerHTML = '';

        // Generate prompts for each selected city
        for (let i = 0; i < selectedCities.length; i++) {
          const city = selectedCities[i];
          
          const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: 'generate_memory_prompts',
              city: city.city,
              country: document.getElementById('countryInput').value
            })
          });

          const data = await response.json();
          
          if (response.ok && data.prompts) {
            displayCityPrompts(city, data.prompts, i);
          } else {
            showMessage(data.error || `Failed to generate prompts for ${city.city}.`);
          }
        }
        
        updateStepProgress(3, 'completed');
      } catch (error) {
        showMessage('Network error. Please try again.');
        console.error('Error:', error);
        updateStepProgress(3, 'error');
      } finally {
        hideLoading();
      }
    }

    function displayCityPrompts(city, prompts, cityIndex) {
      const container = document.getElementById('memoryPromptsContainer');
      
      const citySection = document.createElement('div');
      citySection.className = 'city-section';
      
      const cityHeader = document.createElement('div');
      cityHeader.className = 'city-section-header';
      cityHeader.innerHTML = `
        <div>
          <div class="city-section-title">${city.city}</div>
          <div class="city-section-subtitle">${city.activities.length > 0 ? city.activities.slice(0, 3).join(', ') : 'Your memories here'}</div>
        </div>
      `;
      
      citySection.appendChild(cityHeader);

      prompts.forEach((prompt, promptIndex) => {
        const promptDiv = document.createElement('div');
        promptDiv.className = 'prompt-item';
        const uniqueId = `city${cityIndex}_prompt${promptIndex}`;
        
        promptDiv.innerHTML = `
          <div class="prompt-header">
            <div class="prompt-question">${prompt}</div>
            <button class="refresh-btn" onclick="refreshPrompt('${city.city}', ${promptIndex}, '${uniqueId}')" title="Generate new question">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <textarea class="prompt-input" id="${uniqueId}" placeholder="Share your memory here..."></textarea>
        `;
        citySection.appendChild(promptDiv);
      });

      container.appendChild(citySection);
    }

    async function refreshPrompt(cityName, promptIndex, elementId) {
      const refreshBtn = event.target.closest('.refresh-btn');
      const originalContent = refreshBtn.innerHTML;
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      refreshBtn.disabled = true;

      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'generate_memory_prompts',
            city: cityName,
            country: document.getElementById('countryInput').value
          })
        });

        const data = await response.json();
        
        if (response.ok && data.prompts && data.prompts[promptIndex]) {
          const newPrompt = data.prompts[promptIndex];
          const promptQuestion = refreshBtn.parentElement.querySelector('.prompt-question');
          promptQuestion.textContent = newPrompt;
        } else {
          showMessage('Failed to generate new question.');
        }
      } catch (error) {
        showMessage('Network error. Please try again.');
        console.error('Error:', error);
      } finally {
        refreshBtn.innerHTML = originalContent;
        refreshBtn.disabled = false;
      }
    }

    async function generateNarrative() {
      // Collect user answers from all cities
      userAnswers = [];
      const freeform = document.getElementById('freeformMemory').value.trim();
      if (freeform) userAnswers.push(freeform);
      
      // Collect answers from all prompt inputs
      const answerInputs = document.querySelectorAll('.prompt-input');
      answerInputs.forEach(input => {
        if (input.value.trim()) {
          userAnswers.push(input.value.trim());
        }
      });
      
      if (userAnswers.length === 0) {
        showMessage('Please answer at least one question or write a freeform memory to generate your story.');
        return;
      }
      
      showLoading('Creating your travel narrative...');
      updateStepProgress(4, 'loading');
      
      try {
        // Create a combined narrative for all cities
        const cityNames = selectedCities.map(city => city.city).join(', ');
        
        // Get date information
        const countryMonth = document.getElementById('countryMonth').value;
        const countryYear = document.getElementById('countryYear').value;
        const visitDate = countryMonth && countryYear ? `${countryMonth}/${countryYear}` : null;
        
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'generate_narrative',
            city: cityNames,
            country: document.getElementById('countryInput').value,
            user_answers: userAnswers,
            cities: selectedCities.map(city => city.city), // Pass all city names
            story_length: selectedStoryLength, // Add story length parameter
            story_layout: selectedStoryLayout, // Add story layout parameter
            visit_date: visitDate // Add visit date information
          })
        });
        const data = await response.json();
        if (response.ok && data.narrative) {
          generatedNarrative = data.narrative;
          document.getElementById('narrativeText').textContent = data.narrative;
          updateStepProgress(4, 'completed');
          nextStep();
        } else {
          showMessage(data.error || 'Failed to generate narrative.');
          updateStepProgress(4, 'error');
        }
      } catch (error) {
        showMessage('Network error. Please try again.');
        console.error('Error:', error);
        updateStepProgress(4, 'error');
      } finally {
        hideLoading();
      }
    }

    async function changeStyle(style, btn) {
      if (style === 'original') {
        document.getElementById('narrativeText').textContent = generatedNarrative;
        currentStyle = 'original';
        updateStyleButtons(btn);
        return;
      }

      showLoading();

      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'regenerate_style',
            original_text: generatedNarrative,
            style: style
          })
        });

        const data = await response.json();
        
        if (response.ok && data.narrative) {
          document.getElementById('narrativeText').textContent = data.narrative;
          currentStyle = style;
          updateStyleButtons(btn);
        } else {
          showMessage(data.error || 'Failed to change style.');
        }
      } catch (error) {
        showMessage('Network error. Please try again.');
        console.error('Error:', error);
      } finally {
        hideLoading();
      }
    }

    function updateStyleButtons(btn) {
      document.querySelectorAll('.btn-style').forEach(b => {
        b.classList.remove('active');
      });
      if (btn) btn.classList.add('active');
    }

    async function saveStory() {
      const narrativeText = document.getElementById('narrativeText');
      const narrativeTextarea = document.getElementById('narrativeTextarea');
      
      // Get the current narrative (either from textarea if editing, or from text div)
      const currentNarrative = narrativeTextarea.classList.contains('hidden') 
        ? narrativeText.textContent 
        : narrativeTextarea.value.trim();

      // Get date information
      const countryMonth = document.getElementById('countryMonth').value;
      const countryYear = document.getElementById('countryYear').value;
      const visitDate = countryMonth && countryYear ? `${countryMonth}/${countryYear}` : null;

      const storyData = {
        country: document.getElementById('countryInput').value,
        cities: selectedCities.map(city => city.city), // Save all cities
        city: selectedCities.map(city => city.city).join(', '), // Keep for backward compatibility
        narrative: currentNarrative,
        style: currentStyle,
        layout: selectedStoryLayout,
        photos: uploadedPhotos.map(photo => ({
          name: photo.name,
          data: photo.data
        })),
        user_answers: userAnswers,
        visit_date: visitDate, // Add visit date to saved story
        timestamp: new Date().toISOString()
      };

      showLoading();

      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'save_story',
            story_data: storyData
          })
        });

        const data = await response.json();
        
        if (response.ok && data.saved) {
          showMessage('Your travel story has been saved successfully!', 'success');
          // Exit edit mode if currently editing
          if (!narrativeTextarea.classList.contains('hidden')) {
            toggleEditMode();
          }
          // Clear photos after successful save
          uploadedPhotos = [];
          renderPhotoPreview();
        } else {
          showMessage(data.error || 'Failed to save story.');
        }
      } catch (error) {
        showMessage('Network error. Please try again.');
        console.error('Error:', error);
      } finally {
        hideLoading();
      }
    }

    function updateURL() {
      const params = new URLSearchParams();
      params.set('step', currentStep);
      const country = document.getElementById('countryInput')?.value?.trim();
      if (country) params.set('country', country);
      if (manualCities.length > 0) params.set('manualCities', manualCities.join(','));
      if (selectedCities.length > 0) params.set('selectedCities', selectedCities.map(c => c.city).join(','));
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
    }

    function restoreFromURL() {
      const params = new URLSearchParams(window.location.search);
      const step = parseInt(params.get('step'));
      if (step && step >= 1 && step <= 5) currentStep = step;
      const country = params.get('country');
      if (country) document.getElementById('countryInput').value = country;
      const manual = params.get('manualCities');
      if (manual) {
        manualCities = manual.split(',').filter(Boolean);
        renderManualCities();
      }
      const selected = params.get('selectedCities');
      if (selected) {
        selectedCities = selected.split(',').filter(Boolean).map(city => ({ city, activities: [] }));
      }
      updateStepIndicator();
      showCurrentStep();
    }

    // Patch navigation to update URL
    const _nextStep = nextStep;
    nextStep = async function() {
      await _nextStep.apply(this, arguments);
      updateURL();
    };
    const _previousStep = previousStep;
    previousStep = function() {
      _previousStep.apply(this, arguments);
      updateURL();
    };
    // Patch manual city add/remove to update URL
    const _addManualCity = addManualCities;
    addManualCities = function() {
      _addManualCity.apply(this, arguments);
      updateURL();
    };
    const _removeManualCity = removeManualCity;
    removeManualCity = function(city) {
      _removeManualCity.apply(this, arguments);
      updateURL();
    };
    // Patch country input to update URL
    document.addEventListener('DOMContentLoaded', function() {
      updateStepIndicator();
      renderManualCities();
      restoreFromURL();
      document.getElementById('countryInput').addEventListener('input', updateURL);
      
      // Initialize date dropdowns
      initializeDateDropdowns();
    });

    // Initialize date dropdowns
    function initializeDateDropdowns() {
      const yearSelect = document.getElementById('countryYear');
      const currentYear = new Date().getFullYear();
      
      // Populate year dropdown (from 1990 to current year + 1)
      for (let year = currentYear + 1; year >= 1990; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
      
      // Set default to current year
      yearSelect.value = currentYear;
    }

    function toggleEditMode() {
      const narrativeText = document.getElementById('narrativeText');
      const narrativeTextarea = document.getElementById('narrativeTextarea');
      const editToggleBtn = document.getElementById('editToggleBtn');
      const isEditing = narrativeText.classList.contains('hidden');

      if (!isEditing) {
        // Switch to edit mode
        narrativeText.classList.add('hidden');
        narrativeTextarea.classList.remove('hidden');
        narrativeTextarea.value = narrativeText.textContent;
        editToggleBtn.innerHTML = '<i class="fas fa-save"></i> Save Edits';
        editToggleBtn.classList.remove('btn-secondary');
        editToggleBtn.classList.add('btn-success');
      } else {
        // Save edits and switch back to view mode
        const editedText = narrativeTextarea.value.trim();
        if (editedText) {
          narrativeText.textContent = editedText;
          generatedNarrative = editedText; // Update the stored narrative
        }
        narrativeText.classList.remove('hidden');
        narrativeTextarea.classList.add('hidden');
        editToggleBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Story';
        editToggleBtn.classList.remove('btn-success');
        editToggleBtn.classList.add('btn-secondary');
      }
    }

    // Share functionality
    function shareCountryStories(country) {
      const countryStories = savedStories.filter(story => story.country === country);
      if (countryStories.length === 0) {
        showMessage('No stories found for this country.');
        return;
      }

      // Create a shareable story text
      const storyText = createShareableStory(country, countryStories);
      
      // Store the story text for sharing
      window.currentShareData = {
        country: country,
        stories: countryStories,
        text: storyText,
        url: window.location.href
      };

      // Show the share modal
      document.getElementById('shareModal').classList.add('show');
      
      // Update the share link input
      document.getElementById('shareLinkInput').value = window.location.href;
    }

    function createShareableStory(country, stories) {
      const flagEmoji = getCountryFlag(country);
      let storyText = `${flagEmoji} My Travel Adventures in ${country}\n\n`;
      
      stories.forEach((story, index) => {
        const cities = story.cities ? story.cities.join(', ') : story.city;
        storyText += `üìç ${cities}\n`;
        storyText += `${story.narrative.substring(0, 300)}${story.narrative.length > 300 ? '...' : ''}\n\n`;
      });
      
      storyText += `\nüìñ Created with WanderLog AI - Your Living Travel Memoir`;
      return storyText;
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('show');
      // Reset copy button
      const copyBtn = document.getElementById('copyBtn');
      copyBtn.classList.remove('copied');
      copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
    }

    function shareViaEmail() {
      if (!window.currentShareData) return;
      
      const subject = encodeURIComponent(`My Travel Story: ${window.currentShareData.country}`);
      const body = encodeURIComponent(window.currentShareData.text);
      const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
      
      window.open(mailtoLink);
    }

    function shareViaWhatsApp() {
      if (!window.currentShareData) return;
      
      const text = encodeURIComponent(window.currentShareData.text);
      const whatsappLink = `https://wa.me/?text=${text}`;
      
      window.open(whatsappLink, '_blank');
    }

    function shareViaTwitter() {
      if (!window.currentShareData) return;
      
      const text = encodeURIComponent(window.currentShareData.text.substring(0, 280));
      const twitterLink = `https://twitter.com/intent/tweet?text=${text}`;
      
      window.open(twitterLink, '_blank');
    }

    function shareViaFacebook() {
      if (!window.currentShareData) return;
      
      const url = encodeURIComponent(window.currentShareData.url);
      const facebookLink = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
      
      window.open(facebookLink, '_blank');
    }

    async function copyShareLink() {
      const shareLinkInput = document.getElementById('shareLinkInput');
      const copyBtn = document.getElementById('copyBtn');
      
      try {
        await navigator.clipboard.writeText(shareLinkInput.value);
        copyBtn.classList.add('copied');
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        
        setTimeout(() => {
          copyBtn.classList.remove('copied');
          copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
        }, 2000);
      } catch (err) {
        // Fallback for older browsers
        shareLinkInput.select();
        document.execCommand('copy');
        copyBtn.classList.add('copied');
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        
        setTimeout(() => {
          copyBtn.classList.remove('copied');
          copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
        }, 2000);
      }
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      const shareModal = document.getElementById('shareModal');
      shareModal.addEventListener('click', function(e) {
        if (e.target === shareModal) {
          closeShareModal();
        }
      });
      
      // Initialize photo upload drag and drop
      initializePhotoUpload();
      
      // Initialize country autocomplete
      initCountryAutocomplete();
      
      // Initialize search functionality
      initSearch();
      
      // Initialize story options
      initStoryOptions();
    });

    // Photo Upload Functionality
    let uploadedPhotos = [];

    function initializePhotoUpload() {
      const photoSection = document.getElementById('photoUploadSection');
      const photoInput = document.getElementById('photoInput');

      // Drag and drop functionality
      photoSection.addEventListener('dragover', function(e) {
        e.preventDefault();
        photoSection.classList.add('dragover');
      });

      photoSection.addEventListener('dragleave', function(e) {
        e.preventDefault();
        photoSection.classList.remove('dragover');
      });

      photoSection.addEventListener('drop', function(e) {
        e.preventDefault();
        photoSection.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files);
      });

      // File input change
      photoInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
      });
    }

    function handlePhotoUpload(event) {
      handleFiles(event.target.files);
    }

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const photoData = {
              id: `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              name: file.name,
              data: e.target.result,
              file: file
            };
            uploadedPhotos.push(photoData);
            renderPhotoPreview();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function renderPhotoPreview() {
      const preview = document.getElementById('photoPreview');
      if (uploadedPhotos.length === 0) {
        preview.innerHTML = '';
        return;
      }

      preview.innerHTML = uploadedPhotos.map(photo => `
        <div class="photo-item">
          <img src="${photo.data}" alt="${photo.name}">
          <button class="photo-remove" onclick="removePhoto('${photo.id}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');
    }

    function removePhoto(photoId) {
      console.log('Removing photo with ID:', photoId);
      console.log('Current photos:', uploadedPhotos);
      
      // Find the photo to remove
      const photoIndex = uploadedPhotos.findIndex(photo => photo.id === photoId);
      
      if (photoIndex === -1) {
        console.error('Photo not found with ID:', photoId);
        return;
      }
      
      // Remove the photo from the array
      uploadedPhotos.splice(photoIndex, 1);
      console.log('Photos after removal:', uploadedPhotos);
      
      // Re-render the preview
      renderPhotoPreview();
    }

    // Layout Change Functionality
    function changeLayout(layout) {
      selectedStoryLayout = layout;
      
      // Update active layout option
      document.querySelectorAll('.layout-option').forEach(option => {
        option.classList.remove('active');
      });
      document.querySelector(`[data-layout="${layout}"]`).classList.add('active');
      
      // Apply layout to narrative text
      const narrativeText = document.getElementById('narrativeText');
      const narrativeTextarea = document.getElementById('narrativeTextarea');
      
      // Remove all layout classes
      narrativeText.className = 'narrative-text';
      narrativeTextarea.className = 'narrative-textarea hidden';
      
      // Add new layout class
      narrativeText.classList.add(`story-layout-${layout}`);
      narrativeTextarea.classList.add(`story-layout-${layout}`);
    }

    // Search functionality
    function initSearch() {
      const searchInput = document.getElementById('storySearchInput');
      // Remove filter and clearBtn logic
      if (searchInput) {
        searchInput.addEventListener('input', filterStories);
      }
    }

    function filterStories() {
      const searchTerm = document.getElementById('storySearchInput')?.value.toLowerCase().trim() || '';
      if (!searchTerm) {
        filteredStories = [...savedStories];
        displayStories();
        return;
      }
      filteredStories = savedStories.filter(story => {
        return (
          story.country.toLowerCase().includes(searchTerm) ||
          (story.cities && story.cities.some(city => city.toLowerCase().includes(searchTerm))) ||
          (story.narrative && story.narrative.toLowerCase().includes(searchTerm))
        );
      });
      displayStories();
    }

    function clearSearch() {
      const searchInput = document.getElementById('storySearchInput');
      if (searchInput) searchInput.value = '';
      filteredStories = [...savedStories];
      displayStories();
    }

    function highlightSearchTerm(text, searchTerm) {
      if (!searchTerm) return text;
      
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // Story Length Selection
    function selectStoryLength(length) {
      selectedStoryLength = length;
      
      // Remove active class from all length options
      document.querySelectorAll('.length-option').forEach(option => {
        option.classList.remove('active');
      });
      
      // Add active class to selected option
      event.currentTarget.classList.add('active');
      
      console.log('Selected story length:', length);
    }

    // Story Layout Selection
    function selectLayout(layout) {
      selectedStoryLayout = layout;
      
      // Remove active class from all layout options
      document.querySelectorAll('.layout-option').forEach(option => {
        option.classList.remove('active');
      });
      
      // Add active class to selected option
      event.currentTarget.classList.add('active');
      
      console.log('Selected story layout:', layout);
    }

    // Initialize story options with default selections
    function initStoryOptions() {
      // Set default selections
      document.querySelector('.length-option:nth-child(2)').classList.add('selected'); // Detailed
      document.querySelector('.layout-option:nth-child(1)').classList.add('selected'); // Classic
    }

    // Public Profile Functions
    function initPublicProfile() {
      // Load profile data
      loadProfileData();
      
      // Add event listeners
      document.getElementById('profileName').addEventListener('input', updateProfileName);
      document.getElementById('profileBio').addEventListener('input', updateProfileBio);
      document.getElementById('profilePublic').addEventListener('change', toggleProfilePublic);
      
      // Load public stories
      loadPublicStories();
    }

    function loadProfileData() {
      // Load from localStorage or use defaults
      const savedProfile = localStorage.getItem('wanderlogProfile');
      if (savedProfile) {
        profileData = { ...profileData, ...JSON.parse(savedProfile) };
      }
      
      // Update UI
      document.getElementById('profileName').value = profileData.name;
      document.getElementById('profileBio').value = profileData.bio;
      document.getElementById('profilePublic').checked = profileData.isPublic;
      document.getElementById('profileLink').value = `https://wanderlog.ai/profile/${profileData.name.toLowerCase().replace(/\s+/g, '-')}`;
    }

    function updateProfileName() {
      profileData.name = document.getElementById('profileName').value;
      document.getElementById('profileLink').value = `https://wanderlog.ai/profile/${profileData.name.toLowerCase().replace(/\s+/g, '-')}`;
      saveProfileData();
    }

    function updateProfileBio() {
      profileData.bio = document.getElementById('profileBio').value;
      saveProfileData();
    }

    function toggleProfilePublic() {
      profileData.isPublic = document.getElementById('profilePublic').checked;
      saveProfileData();
      updateProfileStats();
    }

    function saveProfileData() {
      localStorage.setItem('wanderlogProfile', JSON.stringify(profileData));
    }

    function loadPublicStories() {
      // Get stories that are marked as public
      publicStories = savedStories.filter(story => story.isPublic);
      displayPublicStories();
      updateProfileStats();
    }

    function displayPublicStories() {
      const container = document.getElementById('publicStoriesGrid');
      
      if (publicStories.length === 0) {
        container.innerHTML = `
          <div class="no-public-stories">
            <i class="fas fa-globe"></i>
            <h3>No Public Stories Yet</h3>
            <p>Mark some of your stories as public to share them with the world!</p>
          </div>
        `;
        return;
      }

      const storiesHTML = publicStories.map(story => {
        const flagEmoji = getCountryFlag(story.country);
        const excerpt = story.narrative.substring(0, 150) + (story.narrative.length > 150 ? '...' : '');
        
        return `
          <div class="public-story-card" onclick="viewPublicStory('${story.country}')">
            <div class="public-story-header">
              <div class="public-story-flag">${flagEmoji}</div>
              <div class="public-story-info">
                <div class="public-story-title">${story.country}</div>
                <div class="public-story-summary">${story.cities ? story.cities.join(', ') : story.city}</div>
              </div>
            </div>
            <div class="public-story-excerpt">
              <p>${excerpt}</p>
            </div>
            <div class="public-story-actions">
              <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); toggleStoryPublic('${story.country}')">
                <i class="fas fa-eye-slash"></i>
                Make Private
              </button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = storiesHTML;
    }

    function updateProfileStats() {
      if (!profileData.isPublic) {
        document.getElementById('profileCountries').textContent = '0';
        document.getElementById('profileCities').textContent = '0';
        document.getElementById('profileStories').textContent = '0';
        return;
      }

      const countries = new Set(publicStories.map(story => story.country)).size;
      const cities = publicStories.reduce((sum, story) => sum + (story.cities ? story.cities.length : 1), 0);
      const stories = publicStories.length;

      document.getElementById('profileCountries').textContent = countries;
      document.getElementById('profileCities').textContent = cities;
      document.getElementById('profileStories').textContent = stories;
    }

    function toggleStoryPublic(country) {
      const story = savedStories.find(s => s.country === country);
      if (story) {
        story.isPublic = !story.isPublic;
        loadPublicStories();
        showMessage(`Story ${story.isPublic ? 'made public' : 'made private'}`, 'success');
      }
    }

    function copyProfileLink() {
      const linkInput = document.getElementById('profileLink');
      linkInput.select();
      document.execCommand('copy');
      showMessage('Profile link copied to clipboard!', 'success');
    }

    function viewPublicStory(country) {
      const story = publicStories.find(s => s.country === country);
      if (story) {
        showStoryDetailModal(story);
      }
    }

    function toggleCountryPublic(country) {
      const countryStories = savedStories.filter(story => story.country === country);
      const isCurrentlyPublic = countryStories.some(story => story.isPublic);
      
      // Toggle all stories for this country
      countryStories.forEach(story => {
        story.isPublic = !isCurrentlyPublic;
      });
      
      // Refresh the display
      displayStories();
      showMessage(`All ${country} stories ${isCurrentlyPublic ? 'made private' : 'made public'}`, 'success');
    }

    // Export functions
    function showExportOptions() {
      document.getElementById('exportModal').classList.add('show');
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('show');
    }

    function exportAsPDF() {
      if (!window.currentStoryDetail) {
        showMessage('No story selected for export.');
        return;
      }
      
      const story = window.currentStoryDetail;
      createPDF(story);
      
      closeExportModal();
      showMessage('PDF exported successfully!', 'success');
    }

    // Helper function to create PDF
    function createPDF(story) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Set up fonts and styles
      doc.setFont('helvetica');
      doc.setFontSize(24);
      
      // Title
      const flagEmoji = getCountryFlag(story.country);
      const title = `${flagEmoji} Travel Story: ${story.country}`;
      const titleWidth = doc.getTextWidth(title);
      doc.text(title, (210 - titleWidth) / 2, 30);
      
      // Subtitle
      doc.setFontSize(14);
      doc.setTextColor(100, 100, 100);
      const visitDate = formatVisitDate(story.visit_date);
      const cities = story.cities ? story.cities.join(', ') : 'Unknown cities';
      const subtitle = `${visitDate ? visitDate + ' ‚Ä¢ ' : ''}${cities}`;
      const subtitleWidth = doc.getTextWidth(subtitle);
      doc.text(subtitle, (210 - subtitleWidth) / 2, 40);
      
      // Reset text color
      doc.setTextColor(0, 0, 0);
      
      // Add some spacing
      doc.setFontSize(12);
      doc.text('', 20, 60);
      
      // Story content
      const storyText = story.narrative;
      const splitText = doc.splitTextToSize(storyText, 170);
      doc.text(splitText, 20, 70);
      
      // Footer
      doc.setFontSize(10);
      doc.setTextColor(150, 150, 150);
      doc.text('Generated with WanderLog AI', 20, 280);
      
      // Save the PDF
      const filename = `${story.country.replace(/\s+/g, '_')}_story.pdf`;
      doc.save(filename);
    }

    function exportAsDigitalAlbum() {
      if (!window.currentStoryDetail) {
        showMessage('No story selected for export.');
        return;
      }
      
      const story = window.currentStoryDetail;
      const albumHTML = createDigitalAlbumHTML(story);
      
      downloadAsFile(albumHTML, `${story.country}_album.html`, 'text/html');
      
      closeExportModal();
      showMessage('Digital album exported successfully!', 'success');
    }

    // Helper function to create digital album HTML
    function createDigitalAlbumHTML(story) {
      const flagEmoji = getCountryFlag(story.country);
      const visitDate = formatVisitDate(story.visit_date);
      const cities = story.cities ? story.cities.join(', ') : 'Unknown cities';
      
      return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${story.country} - Travel Album</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .album-container {
            max-width: 800px;
            margin: 0 auto;
      background: white;
      border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .album-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .album-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .album-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .album-content {
            padding: 40px;
            line-height: 1.8;
            font-size: 1.1em;
            color: #333;
        }
        
        .story-text {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            margin: 20px 0;
        }
        
        .album-footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
        
        .cities-tag {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin: 10px 5px;
            font-size: 0.9em;
        }
        
        @media print {
            body { background: white; }
            .album-container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="album-container">
        <div class="album-header">
            <h1 class="album-title">${flagEmoji} ${story.country}</h1>
            <p class="album-subtitle">
                ${visitDate ? visitDate : ''}
                ${visitDate && cities ? '‚Ä¢' : ''}
                ${cities}
            </p>
            ${story.cities ? story.cities.map(city => `<span class="cities-tag">${city}</span>`).join('') : ''}
        </div>
        
        <div class="album-content">
            <div class="story-text">
                ${story.narrative.replace(/\n/g, '<br>')}
            </div>
        </div>
        
        <div class="album-footer">
            <p>Generated with WanderLog AI</p>
            <p>Your AI-powered travel companion</p>
        </div>
    </div>
</body>
</html>`;
    }

    function exportForSocialMedia() {
      if (!window.currentStoryDetail) {
        showMessage('No story selected for export.');
        return;
      }
      showMessage('Social media export coming soon!', 'success');
      closeExportModal();
    }

    function exportAsText() {
      if (!window.currentStoryDetail) {
        showMessage('No story selected for export.');
        return;
      }
      
      const story = window.currentStoryDetail;
      const textContent = createTextContent(story);
      
      downloadAsFile(textContent, `${story.country}_story.txt`, 'text/plain');
      
      closeExportModal();
      showMessage('Text file exported successfully!', 'success');
    }

    // Helper function to create text content
    function createTextContent(story) {
      const flagEmoji = getCountryFlag(story.country);
      const visitDate = formatVisitDate(story.visit_date);
      const cities = story.cities ? story.cities.join(', ') : 'Unknown cities';
      
      return `
${flagEmoji} Travel Story: ${story.country}
${visitDate ? `Date: ${visitDate}` : ''}
Cities: ${cities}

${story.narrative}

---
Generated with WanderLog AI
      `.trim();
    }

    // Helper function to download file
    function downloadAsFile(content, filename, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportAsSocialMedia() {
      if (!window.currentStoryDetail) {
        showMessage('No story selected for export.');
        return;
      }
      
      const story = window.currentStoryDetail;
      const socialMediaText = createSocialMediaText(story);
      
      // Copy to clipboard
      navigator.clipboard.writeText(socialMediaText).then(() => {
        showMessage('Social media text copied to clipboard!', 'success');
      }).catch(() => {
        // Fallback: show in modal
        showSocialMediaModal(socialMediaText);
      });
      
      closeExportModal();
    }

    // Helper function to create social media text
    function createSocialMediaText(story) {
      const flagEmoji = getCountryFlag(story.country);
      const visitDate = formatVisitDate(story.visit_date);
      const cities = story.cities ? story.cities.join(', ') : 'Unknown cities';
      
      // Create a shorter version of the narrative for social media
      const shortNarrative = story.narrative.length > 200 
        ? story.narrative.substring(0, 200) + '...' 
        : story.narrative;
      
      return `${flagEmoji} My adventure in ${story.country}${visitDate ? ` (${visitDate})` : ''}

${shortNarrative}

üìç Cities: ${cities}
‚úàÔ∏è Generated with WanderLog AI

#Travel #${story.country.replace(/\s+/g, '')} #WanderLogAI #TravelMemories`;
    }

    // Helper function to show social media modal
    function showSocialMediaModal(text) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h3>Social Media Text</h3>
            <button onclick="this.closest('.modal-overlay').remove()" class="close-btn">&times;</button>
          </div>
          <div class="modal-body">
            <p style="margin-bottom: 15px; color: #666;">Copy this text for your social media posts:</p>
            <textarea 
              style="width: 100%; height: 200px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical;"
              readonly
            >${text}</textarea>
            <div style="margin-top: 15px; text-align: center;">
              <button onclick="navigator.clipboard.writeText(this.previousElementSibling.value).then(() => showMessage('Copied to clipboard!', 'success'))" 
                      class="btn btn-primary">
                Copy to Clipboard
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Clear all data when starting a new story
    function clearStoryData() {
      selectedCities = [];
      manualCities = [];
      aiSuggestedCities = [];
      userAnswers = [];
      generatedNarrative = '';
      currentCityData = {};
      selectedStoryLength = 'medium';
      selectedStoryLayout = 'narrative';
      countryPhotos = {};
      
      // Clear UI
      document.getElementById('countryInput').value = '';
      document.getElementById('manualCityInput').value = '';
      document.getElementById('citiesContainer').innerHTML = '';
      document.getElementById('memoryPromptsContainer').innerHTML = '';
      document.getElementById('freeformMemory').value = '';
      
      // Reset step indicators
      updateStepIndicator();
      
      // Go back to step 1
      currentStep = 1;
      showCurrentStep();
      
      showMessage('All data cleared! Start fresh.', 'success');
    }

    // New function to combine cities from Step 1 and Step 2
    function combineAllCities() {
      console.log('combineAllCities called'); // Debug log
      
      // Combine AI-suggested cities with manually selected cities
      const allSelectedCities = [
        ...aiSuggestedCities.filter(aiCity => 
          selectedCities.some(selectedCity => citiesAreSame(aiCity.city, selectedCity.city))
        ),
        ...selectedCities.filter(selectedCity => 
          !aiSuggestedCities.some(aiCity => citiesAreSame(aiCity.city, selectedCity.city))
        )
      ];
      
      // Also include manual cities that weren't selected in Step 2
      const manualCitiesNotSelected = manualCities.filter(manualCity => 
        !allSelectedCities.some(selectedCity => citiesAreSame(selectedCity.city, manualCity))
      );
      
      // Add manual cities that weren't selected
      manualCitiesNotSelected.forEach(manualCity => {
        allSelectedCities.push({ city: manualCity, activities: [] });
      });
      
      // Remove duplicates (accent-insensitive)
      const uniqueCities = [];
      allSelectedCities.forEach(city => {
        if (!uniqueCities.some(existing => citiesAreSame(existing.city, city.city))) {
          uniqueCities.push(city);
        }
      });
      
      selectedCities = uniqueCities;
      console.log('Combined selectedCities:', selectedCities.map(c => c.city)); // Debug log
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      clearStoryData(); // Clear any existing data on page load
      initCountryAutocomplete();
      showPage('create');
    });

    // New function to auto-fill memory prompts with test data
    function autoFillMemoryPrompts() {
      console.log('Auto-filling memory prompts with test data'); // Debug log
      
      // Fill the freeform memory
      document.getElementById('freeformMemory').value = "I had an amazing time exploring the vibrant culture, delicious food, and beautiful architecture. The locals were incredibly friendly and welcoming. I'll never forget the stunning sunsets and the unforgettable experiences I had.";
      
      // Fill all prompt inputs with sample data
      const answerInputs = document.querySelectorAll('.prompt-input');
      const sampleAnswers = [
        "The food was absolutely incredible! I tried so many local dishes and the flavors were unlike anything I've ever tasted. My favorite was definitely the street food - so authentic and delicious.",
        "I visited several amazing landmarks and historical sites. The architecture was breathtaking and I learned so much about the local history and culture. The guided tours were very informative.",
        "The people were incredibly warm and hospitable. Despite the language barrier, everyone was so helpful and friendly. I made some great connections with locals who showed me around.",
        "The weather was perfect for exploring - sunny days with cool evenings. I spent a lot of time walking around and taking in the beautiful scenery. The climate really enhanced the whole experience.",
        "I stayed in a charming local area that was perfect for experiencing authentic culture. The accommodation was comfortable and the location was ideal for exploring the city on foot."
      ];
      
      answerInputs.forEach((input, index) => {
        const sampleIndex = index % sampleAnswers.length;
        input.value = sampleAnswers[sampleIndex];
      });
      
      showMessage('Test data auto-filled! You can now proceed to generate your story.', 'success');
    }

    // Add after displayStories:
    function onCountryCardClick(event, country) {
      // Only trigger if not clicking an action button
      const actionBtn = event.target.closest('.country-actions .btn');
      if (!actionBtn) {
        viewCountryStories(country);
      }
    }

    // Add a test message to the modal for debugging
    window.addEventListener('DOMContentLoaded', function() {
      var modal = document.getElementById('storyDetailModal');
      if (modal) {
        var testMsg = document.createElement('div');
        testMsg.textContent = '[DEBUG] MODAL IS RENDERED';
        testMsg.style.background = '#fff';
        testMsg.style.color = 'red';
        testMsg.style.fontWeight = 'bold';
        testMsg.style.fontSize = '2rem';
        testMsg.style.padding = '20px';
        testMsg.style.textAlign = 'center';
        modal.insertBefore(testMsg, modal.firstChild);
      }
    });

    // Load saved stories on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSavedStories();
        showView('main');
    });
  </script>
</body>
</html>